<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_images/favicon.png"><link rel="icon" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_images/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="ZhaoXin"><meta name="keywords" content="博客"><meta name="description" content="14-WebSocket  背景 对于实时响应、更新的应用，即服务器可以即时将数据更新变化反映到客户端，传统的请求-响应模式效率低下，在处理此类业务场景时，通常采用的方案有：  短轮询：浏览器每隔一段时间向服务器发送http请求，这种方法浪费带宽，效率低下； 长轮询(comet)：服务器收到客户端请求后，不直接进行响应，先讲请求挂起，判断请求数据是否有更新，如果有，则响应；没有，则到达一定时间限"><meta property="og:type" content="article"><meta property="og:title" content="13-webSocket"><meta property="og:url" content="https://zhaoquaner.github.io/2022/11/23/SpringBoot/14-WebSocket/index.html"><meta property="og:site_name" content="赵圈儿的博客"><meta property="og:description" content="14-WebSocket  背景 对于实时响应、更新的应用，即服务器可以即时将数据更新变化反映到客户端，传统的请求-响应模式效率低下，在处理此类业务场景时，通常采用的方案有：  短轮询：浏览器每隔一段时间向服务器发送http请求，这种方法浪费带宽，效率低下； 长轮询(comet)：服务器收到客户端请求后，不直接进行响应，先讲请求挂起，判断请求数据是否有更新，如果有，则响应；没有，则到达一定时间限"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20221127152608359.png"><meta property="og:image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/325c6b4a-2dc9-4d1c-8e9e-972a344b45c9.gif"><meta property="og:image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/c621db70-9109-46d7-aa81-96c049ba7330.gif"><meta property="article:published_time" content="2022-11-23T06:17:39.000Z"><meta property="article:modified_time" content="2022-11-27T11:10:43.353Z"><meta property="article:author" content="ZhaoXin"><meta property="article:tag" content="JavaWeb"><meta property="article:tag" content="后端"><meta property="article:tag" content="SpringBoot"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20221127152608359.png"><title>13-webSocket - 赵圈儿的博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/css/collpase.css"><link rel="stylesheet" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/css/radius.css"><link rel="stylesheet" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/css/deletefigcaption.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"><link rel="stylesheet" href="/css/font.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"zhaoquaner.github.io",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:30,cursorChar:" ",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:4,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"Text"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"BzK0JfEpsm40LlV9EPIyl4mp-gzGzoHsz",app_key:"MpxSk6ED55Utq83yNrKAMI5c",server_url:"https://bzk0jfep.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script></head><body><style>code{font-weight:400}#board{border-radius:1.5rem}#board-ctn{width:110%;margin-left:-5%}</style><style>.post-content{font-weight:600}</style><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Personal Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="javascript:;"><i class="iconfont icon-music"></i> 播放</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_images/article.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="13-webSocket"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-11-23 14:17" pubdate>2022年11月23日</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i>21k 字 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">13-webSocket</h1><div class="markdown-body"><h1 id="14-websocket"><a class="markdownIt-Anchor" href="#14-websocket"></a> 14-WebSocket</h1><h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2><p>对于实时响应、更新的应用，即服务器可以即时将数据更新变化反映到客户端，传统的请求-响应模式效率低下，在处理此类业务场景时，通常采用的方案有：</p><ul><li>短轮询：浏览器每隔一段时间向服务器发送http请求，这种方法浪费带宽，效率低下；</li><li>长轮询(comet)：服务器收到客户端请求后，不直接进行响应，先讲请求挂起，判断请求数据是否有更新，如果有，则响应；没有，则到达一定时间限制后，关闭连接。这种方法缺点在于，连续挂起同样导致资源浪费；</li><li>SSE：全称Server-SentEvents，允许服务器主动推送数据到客户端，本质与长轮询、短轮询不同；</li><li>WebSocket：HTML5定义的WebSocket协议，它是独立的，创建在TCP之上的协议，该协议可以实现服务器与客户端之间的全双工通信；</li></ul><p>本文主要讲解WebSocket。</p><h2 id="websocket介绍"><a class="markdownIt-Anchor" href="#websocket介绍"></a> WebSocket介绍</h2><p>WebSocket是HTML5一种新的协议，建立在传输层TCP协议之上，实现了客户端和服务器的全双工异步通信。协议简写为<code>ws</code>，<code>wss</code>是加密版本。</p><p>和HTTP协议最大不同有：</p><ul><li>WebSocket是双向通信协议，服务器和客户端都能主动向对方发送数据；</li><li>WebSocket需要类似TCP的握手链接，连接成功后才能相互通信；</li></ul><p>WebSocket连接后，服务器和客户端就可以发送数据，直到连接关闭。</p><h2 id="websocket建立连接"><a class="markdownIt-Anchor" href="#websocket建立连接"></a> WebSocket建立连接</h2><p>WebSocket握手连接阶段，需要使用HTTP协议。</p><p>来看一个WeboSocket握手例子。</p><p>一个HTTP请求报文。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /chat HTTP/1.1<br>Host: server.example.com<br>Upgrade: websocket<br>Connection: Upgrade<br>Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==<br>Sec-WebSocket-Protocol: chat, superchat<br>Sec-WebSocket-Version: 13<br>Origin: http://example.com<br></code></pre></td></tr></table></figure><p>与普通的HTTP请求相比，多了几样东西。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">Connection: Upgrade<br>Upgrade: websocket<br></code></pre></td></tr></table></figure><p><code>Connection</code>表示想升级协议，<code>Upgrade</code>表示想升级协议到<code>WebSocket</code>。</p><p><code>Set-WebSocket-Version</code>表示websocket版本。</p><p>服务器端相应格式为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">HTTP/1.1 101 Switching Protocols<br>Connection:Upgrade<br>Upgrade: websocket<br>Sec-WebSocket-Accept: Oy4NRAQ13jhfONC7bP8dTKb4PTU=<br></code></pre></td></tr></table></figure><p>状态101表示协议切换成功。</p><h2 id="stomp"><a class="markdownIt-Anchor" href="#stomp"></a> STOMP</h2><p>STOMP-Simple Text Oriented Mesage Protocol，面向消息的简单文本协议。</p><p>因为WebSocket是一个消息架构，不强制使用任何特定的消息协议，它依赖于应用层解释消息的含义；</p><p>与处在应用层HTTP不同，WebSocket处在TCP上很薄一层，仅仅将字节流转换成文本/二进制消息，因此对于实际应用来说，WebSocket通信层级过低。</p><p>所以可以在WebSocket之上使用STOMP协议，为浏览器和服务器之间通信增加适当的消息语义。</p><p>STOMP协议提供了一个可互操作的连接格式，允许STOMP客户端与任意STOMP消息代理(Broker)进行交互。</p><p>如何理解STOMP和WebSocket的关系：</p><ul><li>HTTP协议解决了web浏览器发起请求及服务器响应的细节，直接使用WebSocket编程，就好像没有HTTP协议，直接用TCP套接字编写应用一样；</li><li>STOMP是上层协议，WebSocket是底层协议，STOMP在WebSocket上，明确了信息交互双方，消息格式等；</li></ul><h3 id="stomp服务端"><a class="markdownIt-Anchor" href="#stomp服务端"></a> STOMP服务端</h3><p>STOMP服务端被设计为客户端可以向其发送消息的一组目标地址，STOMP协议没有规定目标地址格式，可以由应用定义，例如<code>/topic/a</code>，<code>topic/b</code>等。应用可以规定不同格式表明不同含义。</p><p>例如应用定义以<code>/topic</code>打头的发布订阅模式，消息被所有消费者客户端收到；以<code>/user</code>开头的为点对点模式，只会被一个消费者客户端收到。</p><h3 id="stomp客户端"><a class="markdownIt-Anchor" href="#stomp客户端"></a> STOMP客户端</h3><p>对于STOMP协议来说，客户端会扮演下列两种角色一种：</p><ul><li>作为生产者，通过SEND帧发送消息到指定地址；</li><li>作为消费者，通过发布SUBSCRIBE帧到已知地址进行消息订阅，当生产者发送消息到这个订阅地址后，订阅该地址的其他消费者会通过MESSAGE帧收到该消息。</li></ul><p>因此，WebSocket结合STOMP相当于构建了一个消息分发队列，客户端可以在上述两种角色间转换，订阅机制保证了一个客户端消息可以通过服务器广播到其他客户端，作为生产者，又可以通过服务器发送点对点消息。</p><h2 id="sockjs"><a class="markdownIt-Anchor" href="#sockjs"></a> SockJS</h2><p>SockJS是一个JavaScript库，是为了应对许多浏览器不支持WebSocket协议的问题。SockJS是WebSocket技术的一种模拟，会尽可能对应WebSocket API，优先选择WebSocket连接。但是当服务器或客户端不支持WebSocket时，会使用其他方案例如轮询、iFrame等中择优连接。</p><h2 id="springboot集成websocket"><a class="markdownIt-Anchor" href="#springboot集成websocket"></a> SpringBoot集成WebSocket</h2><p>SpringBoot集成WebSocket有多种方式，这里介绍三种方法：</p><ul><li>原生注解</li><li>Spring封装</li><li>STOMP协议集成</li></ul><p>首先导入所需库。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="原生注解"><a class="markdownIt-Anchor" href="#原生注解"></a> 原生注解</h3><p>使用jdk自带的原生注解实现。</p><p><code>ServerEndpoint</code>表示客户端用来连接服务端的地址，例如<code>ServerEndpoint</code>为<code>/websocket</code>，则客户端可使用<code>ws://ip:port/websocket</code>进行websocket连接。</p><h4 id="创建websocketconfig配置文件"><a class="markdownIt-Anchor" href="#创建websocketconfig配置文件"></a> 创建WebSocketConfig配置文件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ServerEndpointExporter <span class="hljs-title function_">serverEndpointExporter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个配置类很简单，注入<code>ServerEndpointExporter</code>，这个<code>Bean</code>会自动注册使用了<code>ServerEndpoint</code>注解声明的WebSocket Endpoint。</p><p>通过这个<code>Bean</code>，SpringBoot才能扫描到关于websocket注解。</p><h4 id="websocket处理类"><a class="markdownIt-Anchor" href="#websocket处理类"></a> WebSocket处理类</h4><p>使用<code>Component</code>注解表示这是由spring容器管理的对象。虽然<code>Component</code>默认是单例模式，但SpringBoot还是会为每个WebSocket连接初始化一个<code>Bean</code>，所以可以用静态Map保存起来。</p><p><strong>换句话说，每次一个客户端向服务端发起WebSocket连接时，都会创建一个WebSocket对象，同时建立连接时，会自动创建一个<code>Session</code>对象，也就是说，每个连接对应唯一一个<code>Session</code>，服务端发送消息须通过<code>Session</code>。</strong></p><p>其他注解，都是在<code>javax.websocket</code>下，并不是spring提供的，而是jdk自带的：</p><ul><li><code>@ServerEndpoint</code>：通过这个注解，暴露ws连接路径，类似<code>RequestMapping</code>注解，如果值为<code>ws</code>，可以通过<code>ws://127.0.0.1:80/ws</code>进行websocket连接；</li><li><code>@OnOpen</code>：方法注解，当任意一个客户端建立websocket连接成功后会触发这个注解修饰的方法，注意有一个Session参数，这个Session是WebSocket的，还可以加入带<code>@PathParam</code>注解的参数；</li><li><code>@OnClose</code>：方法注解，当某个客户端断开websocket连接后会触发这个注解修饰的方法，注意有一个Session参数；</li><li><code>@OnMessage</code>：方法注解，当客户端发送消息到服务端时，会触发这个注解修饰的方法，有一个String参数，表示客户端传入消息；</li><li><code>@OnError</code>：当websocket建立连接出现异常时，会触发该方法</li></ul><p>服务端向客户端发送消息必须通过上面提到的<code>Session</code>类，通常是在<code>OnOpen</code>方法中，当连接成功后把<code>Session</code>存入Map的value中，当需要发送时，通过<code>key</code>获得<code>session</code>发送，通过<code>session.getBasicRemote().sendText()</code>向客户端发送消息。</p><p>下面例子使用<code>ConCurrentHashMap</code>保存所有连接，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ServerEndpoint(&quot;/websocket/&#123;name&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocket</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Session session;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocket&gt; webSockets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 连接建立成功后，调用的方法</span><br>    <span class="hljs-meta">@OnOpen</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">OnOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam(value = &quot;name&quot;)</span> String name)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;---------------------------&quot;</span>);<br>        <span class="hljs-built_in">this</span>.session = session;<br>        <span class="hljs-built_in">this</span>.name = name;<br><br>        webSockets.put(name ,<span class="hljs-built_in">this</span>);<br>        log.info(<span class="hljs-string">&quot;WebSocket 连接成功, 当前连接人数为: &#123;&#125;&quot;</span>, webSockets.size());<br>        log.info(<span class="hljs-string">&quot;---------------------------&quot;</span>);<br>        groupSending(name + <span class="hljs-string">&quot;来了&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@OnClose</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">OnClose</span><span class="hljs-params">()</span> &#123;<br>        webSockets.remove(<span class="hljs-built_in">this</span>.name);<br>        log.info(<span class="hljs-string">&quot;WebSocket 退出成功, 当前连接人数为: &#123;&#125;&quot;</span>, webSockets.size());<br><br>        groupSending(name + <span class="hljs-string">&quot;走了&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息类型分为两种，群发和私聊</span><br><span class="hljs-comment">     * 消息格式为：</span><br><span class="hljs-comment">     *   群发：group:[消息]</span><br><span class="hljs-comment">     *   私聊: appoint-[用户名]:[消息]</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnMessage</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">OnMessage</span><span class="hljs-params">(String messageStr)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;WebSocket 收到消息: &#123;&#125;&quot;</span>, messageStr);<br>        <span class="hljs-keyword">if</span>(messageStr.startsWith(<span class="hljs-string">&quot;group&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> messageStr.split(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">1</span>];<br>            groupSending(message);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            String[] strs = messageStr.split(<span class="hljs-string">&quot;:&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> strs[<span class="hljs-number">0</span>].split(<span class="hljs-string">&quot;-&quot;</span>)[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> strs[<span class="hljs-number">1</span>];<br>            appointSending(name, message);<br>        &#125;<br><br><br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 群发消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">groupSending</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String name : webSockets.keySet()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                webSockets.get(name).session.getBasicRemote().sendText(message);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私聊</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appointSending</span><span class="hljs-params">(String name, String message)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            webSockets.get(name).session.getBasicRemote().sendText(message);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用<code>websocket</code>在线测试网站，输入url：<code>ws://127.0.0.1:8080/demo/websocket/user1</code>，表示user1对应客户端建立WebSocket连接。</p><h3 id="spring封装"><a class="markdownIt-Anchor" href="#spring封装"></a> Spring封装</h3><h4 id="创建websockethandler"><a class="markdownIt-Anchor" href="#创建websockethandler"></a> 创建WebSocketHandler</h4><p>继承<code>TextWebSocketHandler</code>类，重写其中的几个方法：</p><ul><li><code>afterConnectionEstablished</code>：连接建立后调用，与<code>OnOpen</code>功能相同；</li><li><code>afterConnectionClosed</code>：连接关闭后调用，与<code>OnClose</code>功能相同；</li><li><code>handleTextMessage</code>：服务端收到文本消息时调用，与<code>OnMessage</code>功能相同；</li></ul><p>完整代码为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextWebSocketHandler</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocketSession&gt; sessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession session)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> getName(session);<br>        sessions.put(key, session);<br>        log.info(key + <span class="hljs-string">&quot;: 成功建立连接&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionClosed</span><span class="hljs-params">(WebSocketSession session, CloseStatus status)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> getName(session);<br>        sessions.remove(key);<br>        log.info(key + <span class="hljs-string">&quot;: 成功关闭连接&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTextMessage</span><span class="hljs-params">(WebSocketSession session, TextMessage message)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        log.info(<span class="hljs-string">&quot;WebSocket 收到消息&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">messageStr</span> <span class="hljs-operator">=</span> message.getPayload();<br>        <span class="hljs-keyword">if</span>(messageStr.startsWith(<span class="hljs-string">&quot;group&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> messageStr.split(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">1</span>];<br>            groupSending(msg);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            String[] strs = messageStr.split(<span class="hljs-string">&quot;:&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> strs[<span class="hljs-number">0</span>].split(<span class="hljs-string">&quot;-&quot;</span>)[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> strs[<span class="hljs-number">1</span>];<br>            appointSending(name, msg);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 群发消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">groupSending</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String name : sessions.keySet()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                sessions.get(name).sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(message));<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 私聊</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appointSending</span><span class="hljs-params">(String name, String message)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            sessions.get(name).sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(message));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 获得url的path值，与第一种方式的@PathParam功能相同</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">(WebSocketSession session)</span> &#123;<br>        <span class="hljs-type">URI</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> session.getUri();<br>        <span class="hljs-keyword">if</span>(Objects.isNull(uri) || StrUtil.isEmpty(uri.toString())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> uri.getPath().substring(uri.getPath().lastIndexOf(<span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建websocketconfig"><a class="markdownIt-Anchor" href="#创建websocketconfig"></a> 创建<code>WebSocketConfig</code></h4><p>实现<code>WebSocketConfigurer</code>接口，该接口只有一个方法：</p><p><code>void registerWebSocketHandlers(WebSocketHandlerRegistry registry)</code></p><p>用于注册<code>WebSocket</code>的处理类，并映射到对应地址。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSocket</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> &#123;<br><br>    <span class="hljs-comment">// /websocket/*类的接口，都会交由WebSocketHandler处理</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> &#123;<br>        registry.addHandler(handler(), <span class="hljs-string">&quot;/websocket/*&quot;</span>).setAllowedOrigins(<span class="hljs-string">&quot;*&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> WebSocketHandler <span class="hljs-title function_">handler</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketHandler</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="stomp集成"><a class="markdownIt-Anchor" href="#stomp集成"></a> STOMP集成</h3><p>Spring消息代理的WebSocket架构图为：</p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20221127152608359.png" srcset="/img/loading.gif" lazyload alt="image-20221127152608359" style="zoom:67%"><p>图中各个组件介绍：</p><ul><li>生产者型客户端(左上组件)：通过<code>SEND</code>命令发送消息到某个目的地址</li><li>消费者型客户端(左下组件)：订阅某个目的地址，并接收此目的地址推送过来的消息</li><li><code>request channel</code>：一组用来接收生产者型客户端推送过来消息的线程池</li><li><code>response channel</code>：一组用来推送消息给消费者型客户端的线程池</li><li><code>borker</code>：消息队列管理者，也可以成为消息代理。有自己的地址，客户端可以向其发送订阅指令，它会记录哪些客户端订阅了这个目的地址</li><li>应用目的地址(图中<code>app</code>)：发送到这类目的地址的消息，在到达<code>broker</code>之前，会先路由到由应用写的某个方法，相当于对<code>broker</code>的消息进行一次拦截，目的是针对消息做一些业务处理</li><li>非应用目的地址(图中<code>/topic</code>，也是消息代理地址)：发送到这类目的地址的消息会直接转到<code>broker</code>，不会被应用拦截</li><li><code>SimpAnnotationMethod</code>：发送到应用目的地址的消息在到达<code>borker</code>之前，先路由到的方法，由应用控制</li></ul><h4 id="消息从生产者发出到消费者消费的流转流程"><a class="markdownIt-Anchor" href="#消息从生产者发出到消费者消费的流转流程"></a> 消息从生产者发出到消费者消费的流转流程</h4><ol><li>生产者通过发送一条<code>SEND</code>命令消息到某个目的地址<code>destination</code></li><li>服务端<code>request channel</code>接受到该条命令，如果目的地址是应用目的地址，则转到对应业务方法(<code>SimpAnnotationMethod</code>)处理，再转到<code>borker</code>(<code>SimpleBroker</code>)；如果目的地址是非应用目的地址，则直接转到<code>borker</code></li><li><code>borker</code>通过<code>SEND</code>命令消息构建<code>MESSAGE</code>命令消息，再通过<code>response channel</code>推送<code>MESSAGE</code>命令消息到所有订阅此目的地址的消费者</li></ol><h4 id="配置类"><a class="markdownIt-Anchor" href="#配置类"></a> 配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSocketMessageBroker</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketMessageBrokerConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerStompEndpoints</span><span class="hljs-params">(StompEndpointRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 配置客户端连接地址</span><br>        registry.addEndpoint(<span class="hljs-string">&quot;/ws&quot;</span>).setAllowedOrigins(<span class="hljs-string">&quot;*&quot;</span>).withSockJS();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureMessageBroker</span><span class="hljs-params">(MessageBrokerRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 设置广播节点</span><br>        registry.enableSimpleBroker(<span class="hljs-string">&quot;/topic&quot;</span>, <span class="hljs-string">&quot;/user&quot;</span>);<br>        <span class="hljs-comment">// 客户端向服务端发送消息须有/app前缀</span><br>        registry.setApplicationDestinationPrefixes(<span class="hljs-string">&quot;/app&quot;</span>);<br>        <span class="hljs-comment">// 指定用户发送(一对一)的前缀/user/</span><br>        registry.setUserDestinationPrefix(<span class="hljs-string">&quot;/user&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>通过实现<code>WebSocketMessageBrokerConfigurer</code>接口加上注解<code>@EnableWebSocketMessageBroker</code>进行STOMP的配置和注解扫描</li><li>其中覆盖<code>registerStompEndpoints</code>方法设置暴露的<code>STOMP</code>路径，并进行跨域设置，<code>withSockJS()</code>表示允许<code>SockJS</code></li><li>覆盖<code>configureMessageBroker</code>方法进行节点配置：<ol><li><code>enableSimpleBroker</code>配置广播节点，也就是服务器发送消息，客户端订阅就能接收消息的节点</li><li>覆盖<code>setApplicationDestinationPrefixes</code>方法，设置客户端向服务器发送消息的节点</li><li>覆盖<code>setUserDestinationPrefix</code>方法，设置一对一通信的节点</li></ol></li></ul><h4 id="捋一下"><a class="markdownIt-Anchor" href="#捋一下"></a> 捋一下</h4><p>广播节点是<code>/topic</code>，一对一节点是<code>/user</code></p><p>客户端向服务端发消息必须带上前缀<code>/app</code>，然后不同后缀对应不同处理方法，服务端使用<code>@MessageMapping</code>定义，和<code>@RequestMapping</code>用法基本相同。</p><blockquote><p>使用<code>@MessageMapping</code>需要在配置类开启注解<code>@EnableWebSocketMessageBroker</code></p></blockquote><p>例如在控制器类(注解了<code>@Controller</code>)中，有个注解了<code>@MessageMapping(&quot;/hello&quot;)</code>的方法，那么客户端发送消息的URL为：<code>/app/hello</code>，服务端会转给这个方法进行处理。</p><p>服务端向客户端发送消息有两种方式：广播和一对一。</p><p>广播地址前缀是<code>topic</code>，一对一节点是<code>/user</code>。</p><p>先说广播：</p><p>有两种发送消息方式，使用注解<code>@SendTo</code>或<code>SimpMessagingTemplate</code>对象。</p><p><code>@SendTo</code>注解修饰方法，该方法的返回值就是<code>SendTo</code>发送的消息，但是<code>@SendTo</code>不能单独使用，需要和<code>@MessageMapping</code>结合使用。</p><p>因此这两个注解的分工是：</p><ul><li><code>@MessageMapping</code>负责接收客户端发来的消息</li><li><code>@SendTo</code>负责发送消息给对应的广播地址</li></ul><p>另一种是使用<code>SimpMessagingTemplate</code>对象，该对象会自动注入，该对象有两种发送消息方法：</p><ul><li><code>convertAndSend()</code></li><li><code>convertAndSendToUser()</code></li></ul><p>以及对应的重载方法。</p><p>一对一节点：</p><p>同样可使用<code>SimpMessagingTemplate</code>对象发送，或者注解<code>@SendToUser</code>，用法和<code>@SendTo</code>基本一样。</p><h4 id="例子"><a class="markdownIt-Anchor" href="#例子"></a> 例子</h4><p>首先定义一个<code>Message</code>实体类，用于服务端和客户端数据传输。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> &#123;<br>    <span class="hljs-keyword">private</span> String code;<br>    <span class="hljs-keyword">private</span> String form;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 去自（保证唯一）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String to;<br>    <span class="hljs-keyword">private</span> String content;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h4><p>配置两个<code>ServerEndpoint</code>，分别用于广播和点对点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSocketMessageBroker</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketMessageBrokerConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerStompEndpoints</span><span class="hljs-params">(StompEndpointRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 配置客户端连接地址</span><br>       <span class="hljs-comment">// 广播连接地址</span><br>       registry.addEndpoint(<span class="hljs-string">&quot;/ws/public&quot;</span>).setAllowedOriginPatterns(<span class="hljs-string">&quot;*&quot;</span>).withSockJS();<br>       <span class="hljs-comment">// 点对点连接地址</span><br>       registry.addEndpoint(<span class="hljs-string">&quot;/ws/private&quot;</span>).setAllowedOriginPatterns(<span class="hljs-string">&quot;*&quot;</span>).withSockJS();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureMessageBroker</span><span class="hljs-params">(MessageBrokerRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 设置广播和点对点发送地址</span><br>        registry.enableSimpleBroker(<span class="hljs-string">&quot;/topic&quot;</span>, <span class="hljs-string">&quot;/user&quot;</span>);<br>        <span class="hljs-comment">// 客户端向服务端发送消息须有/app前缀</span><br>        registry.setApplicationDestinationPrefixes(<span class="hljs-string">&quot;/app&quot;</span>);<br>        <span class="hljs-comment">// 指定用户发送(一对一)的前缀/user/</span><br>        registry.setUserDestinationPrefix(<span class="hljs-string">&quot;/user&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="广播"><a class="markdownIt-Anchor" href="#广播"></a> 广播</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WSController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SimpMessagingTemplate wsTemplate;<br><br>    <span class="hljs-meta">@MessageMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-meta">@SendTo(&quot;/topic/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;接受消息: &quot;</span> +  message);<br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> JSONUtil.toBean(message, Message.class);<br><span class="hljs-comment">//        wsTemplate.convertAndSend(&quot;/topic/hello&quot;, msg.getContent());</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;自定义消息：&quot;</span> + msg.getContent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里服务端向客户端发送消息使用了注解<code>@SendTo</code>，也可以去掉注释行，使用<code>SimpMessagingTemplate</code>对象。</p><p>前端代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>等系统推消息<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://code.jquery.com/jquery-3.2.0.min.js&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha256-JAW99MJVpJBGcbzEuXk4Az05s/XyDdBomFqNlM3ic+I=&quot;</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> stompClient = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setConnected</span>(<span class="hljs-params">connected</span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;connect&quot;</span>).<span class="hljs-property">disabled</span> = connected;</span><br><span class="language-javascript">      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;disconnect&quot;</span>).<span class="hljs-property">disabled</span> = !connected;</span><br><span class="language-javascript">      $(<span class="hljs-string">&quot;#response&quot;</span>).<span class="hljs-title function_">html</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">	 <span class="hljs-comment">// 建立WebSocket连接</span></span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SockJS</span>(<span class="hljs-string">&quot;http://localhost:8080/ws/public&quot;</span>);</span><br><span class="language-javascript">      stompClient = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">over</span>(socket);</span><br><span class="language-javascript">      stompClient.<span class="hljs-title function_">connect</span>(&#123;&#125;, <span class="hljs-keyword">function</span> (<span class="hljs-params">frame</span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">true</span>);</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Connected: &#x27;</span> + frame);</span><br><span class="language-javascript">        <span class="hljs-comment">// 订阅/topic/hello广播  </span></span><br><span class="language-javascript">        stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">&#x27;/topic/hello&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;</span><br><span class="language-javascript">          <span class="hljs-keyword">var</span> responseData = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;responseData&#x27;</span>);</span><br><span class="language-javascript">          <span class="hljs-keyword">var</span> p = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;p&#x27;</span>);</span><br><span class="language-javascript">          p.<span class="hljs-property">style</span>.<span class="hljs-property">wordWrap</span> = <span class="hljs-string">&#x27;break-word&#x27;</span>;</span><br><span class="language-javascript">          p.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(response.<span class="hljs-property">body</span>));</span><br><span class="language-javascript">          responseData.<span class="hljs-title function_">appendChild</span>(p);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">      &#125;,&#123;&#125;);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">if</span> (stompClient != <span class="hljs-literal">null</span>) &#123;</span><br><span class="language-javascript">        stompClient.<span class="hljs-title function_">disconnect</span>();</span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">      <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">false</span>);</span><br><span class="language-javascript">      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Disconnected&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">	<span class="hljs-comment">// 向服务端发送消息，需要加上/app前缀，/hello是自定义的，后端须有对应处理方法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMsg</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;content&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">      stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;/app/hello&quot;</span>,&#123;&#125;,<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<span class="hljs-string">&#x27;content&#x27;</span>: content&#125;));</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;disconnect()&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: #ff0000&quot;</span>&gt;</span>Seems your browser doesn&#x27;t support Javascript! Websocket relies on Javascript being<br>  enabled. Please enable<br>  Javascript and reload this page!<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>连接广播频道<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connect&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;connect();&quot;</span>&gt;</span>Connect<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>取消连接<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;disconnect&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&quot;disabled&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;disconnect();&quot;</span>&gt;</span>Disconnect<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;conversationDiv&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>广播消息<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sendMsg&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;sendMsg();&quot;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>接收到的消息:<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;responseData&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>实现效果：</p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/325c6b4a-2dc9-4d1c-8e9e-972a344b45c9.gif" srcset="/img/loading.gif" lazyload alt="325c6b4a-2dc9-4d1c-8e9e-972a344b45c9" style="zoom:67%"><h4 id="一对一"><a class="markdownIt-Anchor" href="#一对一"></a> 一对一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WSController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SimpMessagingTemplate wsTemplate;<br><br>    <span class="hljs-meta">@MessageMapping(&quot;/alone&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushToOne</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Message msg)</span> &#123;<br>        wsTemplate.convertAndSendToUser(msg.getTo(), <span class="hljs-string">&quot;/message&quot;</span>, msg.getContent());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里服务端向指定客户端发送消息使用的是<code>SimpMessagingTemplate</code>对象，不能使用注解<code>@SendToUser</code>，因为<code>Message</code>对象决定了给哪一个客户端发送消息，使用注解无法提前确定客户端。</p><p>前端代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>聊起来<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://code.jquery.com/jquery-3.2.0.min.js&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha256-JAW99MJVpJBGcbzEuXk4Az05s/XyDdBomFqNlM3ic+I=&quot;</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> stompClient = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setConnected</span>(<span class="hljs-params">connected</span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;connect&quot;</span>).<span class="hljs-property">disabled</span> = connected;</span><br><span class="language-javascript">      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;disconnect&quot;</span>).<span class="hljs-property">disabled</span> = !connected;</span><br><span class="language-javascript">      $(<span class="hljs-string">&quot;#response&quot;</span>).<span class="hljs-title function_">html</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SockJS</span>(<span class="hljs-string">&quot;http://localhost:8080/ws/private&quot;</span>);</span><br><span class="language-javascript">      stompClient = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">over</span>(socket);</span><br><span class="language-javascript">      stompClient.<span class="hljs-property">heartbeat</span>.<span class="hljs-property">outgoing</span> = <span class="hljs-number">20000</span>;</span><br><span class="language-javascript">      <span class="hljs-comment">// client will send heartbeats every 20000ms</span></span><br><span class="language-javascript">      stompClient.<span class="hljs-property">heartbeat</span>.<span class="hljs-property">incoming</span> = <span class="hljs-number">0</span>;</span><br><span class="language-javascript">      stompClient.<span class="hljs-title function_">connect</span>(&#123;&#125;, <span class="hljs-keyword">function</span> (<span class="hljs-params">frame</span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">true</span>);</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Connected: &#x27;</span> + frame);</span><br><span class="language-javascript">        stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">&#x27;/user/&#x27;</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;user&#x27;</span>).<span class="hljs-property">value</span> + <span class="hljs-string">&#x27;/message&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;</span><br><span class="language-javascript">          <span class="hljs-keyword">var</span> responseData = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;responseData&#x27;</span>);</span><br><span class="language-javascript">          <span class="hljs-keyword">var</span> p = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;p&#x27;</span>);</span><br><span class="language-javascript">          p.<span class="hljs-property">style</span>.<span class="hljs-property">wordWrap</span> = <span class="hljs-string">&#x27;break-word&#x27;</span>;</span><br><span class="language-javascript">          p.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(response.<span class="hljs-property">body</span>));</span><br><span class="language-javascript">          responseData.<span class="hljs-title function_">appendChild</span>(p);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">      &#125;);</span><br><span class="language-javascript"></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">if</span> (stompClient != <span class="hljs-literal">null</span>) &#123;</span><br><span class="language-javascript">        stompClient.<span class="hljs-title function_">disconnect</span>();</span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">      <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">false</span>);</span><br><span class="language-javascript">      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Disconnected&quot;</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMsg</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;content&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> to = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;to&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">      stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;/app/alone&quot;</span>, &#123;<span class="hljs-string">&#x27;accessToken&#x27;</span>: <span class="hljs-string">&#x27;HWPO325J9814GBHJF933&#x27;</span>&#125;, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-string">&#x27;content&#x27;</span>: content,</span><br><span class="language-javascript">        <span class="hljs-string">&#x27;to&#x27;</span>: to</span><br><span class="language-javascript">      &#125;));</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;disconnect()&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: #ff0000&quot;</span>&gt;</span>Seems your browser doesn&#x27;t support Javascript! Websocket relies on Javascript being<br>  enabled. Please enable<br>  Javascript and reload this page!<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>连接用户<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connect&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;connect();&quot;</span>&gt;</span>Connect<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>取消连接<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;disconnect&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&quot;disabled&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;disconnect();&quot;</span>&gt;</span>Disconnect<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;conversationDiv&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>发给谁<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;to&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sendMsg&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;sendMsg();&quot;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">labal</span>&gt;</span>接收到的消息:<span class="hljs-tag">&lt;/<span class="hljs-name">labal</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;responseData&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注意，前端代码在建立WebSocket连接时，同时订阅了<code>/user/&lt;&gt;/message</code>这个地址，<code>/user</code>开头，是一个一对一地址。其中<code>&lt;&gt;</code>是用户自定义的名字，例如自定义为<code>name1</code>，则该客户端订阅了<code>/user/name1/message</code>这个地址，其他用户想要给该用户发消息，就通过这个<code>name1</code>。</p><p>至于为什么地址是这种格式，看一下<code>convertAndSendToUser</code>的源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertAndSendToUser</span><span class="hljs-params">(String user, String destination,</span><br><span class="hljs-params">            Object payload,</span><br><span class="hljs-params">            <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; headers, </span><br><span class="hljs-params">            <span class="hljs-meta">@Nullable</span> MessagePostProcessor postProcessor)</span><span class="hljs-keyword">throws</span> MessagingException &#123;<br>	Assert.notNull(user, <span class="hljs-string">&quot;User must not be null&quot;</span>);<br>	Assert.isTrue(!user.contains(<span class="hljs-string">&quot;%2F&quot;</span>), <br>        <span class="hljs-string">&quot;Invalid sequence \&quot;%2F\&quot; in user name: &quot;</span> + user);<br>	user = StringUtils.replace(user, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;%2F&quot;</span>);<br>	destination = destination.startsWith(<span class="hljs-string">&quot;/&quot;</span>) ? destination : <span class="hljs-string">&quot;/&quot;</span> + destination;<br>	<span class="hljs-built_in">super</span>.convertAndSend(<span class="hljs-built_in">this</span>.destinationPrefix + user + destination, <br>                            payload, headers, postProcessor);<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到，在最后一行，调用了<code>convertAndSend</code>方法，发送地址拼接为<code>this.destinationPrefix + user + destination</code>，其中<code>this.destinationPrefix</code>就是在配置类<code>WebSocketConfig</code>中设置的，这里<code>this.destinationPrefix = &quot;/user/&quot;</code>。</p><p><code>user</code>是入参，指定了要发送的用户名，<code>destination</code>也是入参，一个自定义参数，前后端代码保持一致即可。</p><p>服务端的注解<code>@MessageMapping(&quot;/alone&quot;)</code>，不需要加<code>/app</code>，但是客户端向服务端发送消息时，需要加上前缀变成：<code>/app/alone</code>。</p><p>实现效果为：</p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/c621db70-9109-46d7-aa81-96c049ba7330.gif" srcset="/img/loading.gif" lazyload alt="c621db70-9109-46d7-aa81-96c049ba7330" style="zoom:50%"><h4 id="备注"><a class="markdownIt-Anchor" href="#备注"></a> 备注</h4><p>还有一个注解，<code>@SubscribeMapping</code>。</p><p>标记在方法上，用于将客户端以<code>app</code>开头的订阅路由到对应的方法上，默认情况下，返回值会直接发送给客户端，不经过消息代理<code>Broker</code>，是一次性的。可以通过<code>@SendTo</code>或<code>@SendToUser</code>修改这一行为，也就是先将返回值发给消息代理<code>borker</code>，然后广播出去。</p><p>一般用于初始化数据，例如登入聊天室后，初始化在线人员列表和历史消息等。</p><p>例如<code>@SubscribeMapping(&quot;/init&quot;)</code>，则前端代码通过<code>stompClient.subscribe(&quot;/app/init&quot;)</code>，路由到该注解修饰的方法。</p><h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4><p>对于客户端或用户，有三种动作：</p><ol><li>根据服务端设定的<code>ServerEndpoint</code>地址，建立WebSocket连接</li><li>订阅地址，包括广播地址(以<code>/topic</code>开头)和一对一地址(以<code>/user</code>开头)，这两种地址都自定义在配置类中</li><li>向服务端发送消息，所有消息发送地址均以<code>/app</code>开头</li></ol><p>对于服务端，有四种动作：</p><ol><li>处理客户端的WebSocket连接请求，不需要代码自定义配置，设定好<code>ServerEndpoint</code>地址即可</li><li>处理客户端的订阅请求，可以使用<code>@SubscribeMapping</code>接收，但这是一次性的，较少使用。服务端需要配置好广播地址和一对一地址，保证正确发送消息，一般也不需要代码自定义配置订阅</li><li>接收客户端的消息，以<code>/app</code>开头的消息，通过<code>@MessageMapping</code>接收，并根据参数广播消息或一对一发送消息</li><li>向客户端发送消息，既可以是一个客户端向另一个客户端发送的消息，例如聊天室；也可以是服务端主动推送某些更新消息，例如天气应用，实时更新，通过注解<code>@SendTo</code>和<code>@SendToUser</code>，不过注解只能和<code>@MessageMapping</code>结合，使用范围比较窄。<code>SimpMessagingTemplate</code>对象使用范围广，推荐使用。</li></ol></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/programming/" class="category-chain-item">编程学习</a> <span>></span> <a href="/categories/programming/springboot/" class="category-chain-item">SpringBoot</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/javaweb/">#JavaWeb</a> <a href="/tags/backend/">#后端</a> <a href="/tags/springboot/">#SpringBoot</a></div></div><div class="license-box my-3"><div class="license-title"><div>13-webSocket</div><div>https://zhaoquaner.github.io/2022/11/23/SpringBoot/14-WebSocket/</div></div><div class="license-meta"><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年11月27日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"></div></div></div><script>Fluid.utils.createScript("https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js",function(){mermaid.initialize({theme:"default"})})</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><link rel="stylesheet" href="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/css/APlayer.min.css"><div id="aplayer" style="display:none"></div><script src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_js/APlayer.min.js"></script></div></div></main><footer><div class="footer-inner"><div class="footer-content"><i class="iconfont icon-copyright"></i> <span>ZhaoXin, Built with </span><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>& </span><a href="https://hexo.fluid-dev.com/" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-t}),0<o.find(".toc-list-item").length&&o.css("visibility","visible"))})</script><script>!function(){var i,t=CONFIG.code_language.enable&&CONFIG.code_language.default,c=CONFIG.copy_btn;(t||c)&&(i="",i+='<div class="code-widget">',i+="LANG",i+="</div>",jQuery(".markdown-body pre").each(function(){var e,a,n=jQuery(this);0<n.find("code.mermaid").length||0<n.find("span.line").length||(e="",t&&(e=CONFIG.code_language.default,0<n[0].children.length&&2<=n[0].children[0].classList.length&&n.children().hasClass("hljs")?e=n[0].children[0].classList[1]:n[0].getAttribute("data-language")?e=n[0].getAttribute("data-language"):n.parent().hasClass("sourceCode")&&0<n[0].children.length&&2<=n[0].children[0].classList.length?(e=n[0].children[0].classList[1],n.parent().addClass("code-wrapper")):n.parent().hasClass("markdown-body")&&0===n[0].classList.length&&n.wrap('<div class="code-wrapper"></div>'),e=e.toUpperCase().replace("NONE",CONFIG.code_language.default)),n.append(i.replace("LANG",e).replace('code-widget">',(a=n[0],(0<=Fluid.utils.getBackgroundLightness(a)?"code-widget-light":"code-widget-dark")+(c?' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>':' code-widget">')))),c&&Fluid.utils.createScript("https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js",function(){new window.ClipboardJS(".copy-btn",{target:function(e){for(var a=e.parentNode.childNodes,n=0;n<a.length;n++)if("CODE"===a[n].tagName)return a[n]}}).on("success",function(e){e.clearSelection(),e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-copy","icon-success"),setTimeout(function(){e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-success","icon-copy")},2e3)})}))}))}()</script><script>Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="/js/leancloud.js"></script><script src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_js/music.js"></script><script src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog/blog_js/collapse.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>