<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhaoquaner.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="赵圈儿的博客">
<meta property="og:url" content="https://zhaoquaner.github.io/page/11/index.html">
<meta property="og:site_name" content="赵圈儿的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ZhaoXin">
<meta property="article:tag" content="博客">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zhaoquaner.github.io/page/11/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/11/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>赵圈儿的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">赵圈儿的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">23</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">18</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">169</span></a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZhaoXin"
      src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
  <p class="site-author-name" itemprop="name">ZhaoXin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">169</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zhaoquaner" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaoquaner" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zx1522202417@163.com" title="E-Mail → mailto:zx1522202417@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/MyBatis/3-%E4%BC%A0%E7%BB%9FDAO%E5%92%8C%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/MyBatis/3-%E4%BC%A0%E7%BB%9FDAO%E5%92%8C%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">3-传统DAO和动态代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:58:02 / 修改时间：17:00:07" itemprop="dateCreated datePublished" datetime="2022-05-11T13:58:02+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/mybatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在之前使用MyBatis的时候，我们首先创建了实体类，接口，映射文件和主配置文件，然后在测试代码中加载主配置文件，然后调用SqlSession的方法来操作数据库，参数是sqlId，<strong>但是，我们可以发现，接口在整个过程中并没有发挥作用，我们只是将mapper的namespace设为接口的全限定名称，id是接口内的方法名，但这两个其实是自定义的，它并不和接口挂钩。</strong></p>
<p>那么为什么还要创建接口呢？</p>
<p>首先回顾一下传统DAO应该如何使用。</p>
<h2 id="传统dao">传统DAO</h2>
<p>这部分比较简单，不做例子分析。</p>
<p>在传统DAO中，首先创建出接口，映射文件和主配置文件，然后创建接口的实现类，实现接口的方法，其实就相当于把测试方法中的代码挪到实现类中的方法。然后创建实现类对象，调用方法来访问数据库。</p>
<p>也就是我们实际上是需要手动创建出接口的实现类的。</p>
<h2 id="动态代理">动态代理</h2>
<p>在映射文件中，规定了mapper的namespace必须是接口的全限定类名，id必须是接口的方法名。这么做是必要的。因为dao对象，类型是DAO接口，全限定类名和namespace一致，实现类的方法名称也和id值一致。</p>
<p>同时，dao中方法的返回值也可以确定SqlSession要调用的方法。</p>
<p>如果返回值是List，那么就调用selectList方法；如果是int，那么看mapper文件中insert、update标签，就会调用对应方法。</p>
<p>那么就可以使用MyBatis的动态代理，来让MyBatis框架创建出接口的实现类，而不需要手动创建，底层原理实际就是使用的反射。</p>
<p>MyBatis的动态代理：</p>
<p>mybatis根据dao的方法调用，获取执行sql语句的信息，mybatis根据dao接口，创建出一个dao接口的实现类，并创建这个类的对象，完成sqlSession调用方法，访问数据库。</p>
<p><strong>我们使用SqlSession的getMapper(Class)方法来获取接口的实现类对象，参数是class。</strong></p>
<p>例子：</p>
<p>改写之前的查询操作</p>
<p>映射文件和接口不需要修改，只需要在使用时，获取SqlSession对象后，调用它的getMapper方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectStudent</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MyBatisUtils.getSqlSession();</span><br><span class="line">    <span class="type">StudentDao</span> <span class="variable">dao</span> <span class="operator">=</span> sqlSession.getMapper(StudentDao.class);</span><br><span class="line">    List&lt;Student&gt; list = dao.selectStudents();</span><br><span class="line">    <span class="keyword">for</span>(Student stu : list) &#123;</span><br><span class="line">        System.out.println(stu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码中可以看出，getMapper返回接口实现类，然后用该实现类去调用对应方法，那么MyBatis就会根据该类的全限定类名和调用的方法名去映射文件中找到对应sql语句，并执行它，返回结果。</p>
<p>实际开发中，这种用法是很常见的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/MyBatis/2-MyBatis%E4%B8%AD%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/MyBatis/2-MyBatis%E4%B8%AD%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84%E7%B1%BB/" class="post-title-link" itemprop="url">2-MyBatis中常用的类</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:58:01 / 修改时间：17:00:05" itemprop="dateCreated datePublished" datetime="2022-05-11T13:58:01+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/mybatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="resources">Resources</h2>
<p>负责读取主配置文件的，<code>InputStream in =
Resources.getResourceAsStram("mybatis.xml");</code></p>
<p>没有其他作用</p>
<h2 id="sqlsessionfactorybuilder">SqlSessionFactoryBuilder</h2>
<p>负责创建SqlSessionFactory对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SqlSessionFactoryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> builder.build(in);</span><br></pre></td></tr></table></figure>
<h2 id="sqlsessionfactory">SqlSessionFactory</h2>
<p>它是一个接口，用来获取SqlSession对象。是比较重量级的对象，程序创建该对象耗时较长，使用的资源多，在整个项目中，有一个就够用了。</p>
<p>使用该接口的openSession()方法来获取SqlSession对象，该方法有几种重载形式，常见有</p>
<ul>
<li>openSession()：获取一个非自动提交事务的SqlSession对象</li>
<li>openSession(boolean
autoCommit)：参数是boolean，值为true，表示获取自动提交事务的SqlSession；false，表示非自动提交事务的SqlSession对象。</li>
</ul>
<h2 id="sqlsession">SqlSession</h2>
<p>是一个接口，定义了操作数据的方法，常见有查询，插入，更新，删除操作。</p>
<p>但注意：SqlSession对象不是线程安全的，需要在方法内部使用，在执行sql语句之前，使用openSession()方法获取SqlSession对象，执行完sql语句后，执行SqlSession.close()关闭它。</p>
<h2 id="工具类">工具类</h2>
<p>可以把加载主配置文件，创建SqlSessionFactory等操作封装起来，创建一个工具类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisUtils</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;mybatis.xml&quot;</span>;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Resources.getResourceAsStream(config);</span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(in);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(sqlSessionFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">            sqlSession = sqlSessionFactory.openSession();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sqlSession;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/MyBatis/1-MyBatis%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/MyBatis/1-MyBatis%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">1-MyBatis基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:58:00 / 修改时间：17:00:02" itemprop="dateCreated datePublished" datetime="2022-05-11T13:58:00+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/mybatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="基本概念">基本概念</h2>
<p>MyBatis框架是一个基于Java的持久层(数据访问层)框架，内部封装了JDBC,开发者只需要关注SQL语句本身，将处理加载驱动、创建连接、创建statement、关闭连接、资源等繁琐的过程全都交给MyBatis来处理。</p>
<p>MyBatis通过XML或注解两种方式将要执行的各种sql语句配置起来，并通过Java对象和sql的动态参数进行映射生成最终的sql语句，最后由MyBatis框架执行sql并将结果映射为java对象返回。</p>
<p>很重要的一个概念是映射，它的意思是数据库中每一行的数据都可以映射为一个Java对象，我们会创建对应的实体类，保持成员变量和表中属性一致。</p>
<p>创建数据库表<code>Student(id int, name varchar(255), email
varchar(255), age int)</code></p>
<p>其中主键是id。</p>
<p>创建实体类Student，放在包org.example.domain中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//set和get方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建StudentDao接口，放在包org.example.dao中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">selectStudents</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在之后，都是以这个作为例子。</p>
<h2 id="使用mybatis步骤">使用MyBatis步骤</h2>
<h3 id="创建mysql表">创建Mysql表</h3>
<p>首先要在Mysql中创建相应表。</p>
<h3 id="创建对应实体类">创建对应实体类</h3>
<p>在Java中创建实体类，使成员变量和表中属性一致</p>
<h3 id="创建持久层的dao接口">创建持久层的DAO接口</h3>
<p>在持久层创建该表的DAO接口，定义操作该表的方法</p>
<h3 id="创建sql映射文件">创建sql映射文件</h3>
<p>这个是MyBatis使用的配置文件，是用来写sql语句的。一般，一个表一个sql映射文件。</p>
<p>该文件应和DAO接口放在同一文件中，文件名也和接口保持一致。</p>
<h3 id="创建主配置文件">创建主配置文件</h3>
<p>这个配置文件是MyBatis的主配置文件，一个项目中只有一个主配置文件，它提供了数据库的连接信息和sql映射文件的位置信息。</p>
<h3
id="使用mybatis访问数据库使用sqlsession最简单的一种情况">使用mybatis访问数据库(使用SqlSession，最简单的一种情况)</h3>
<h4 id="设置主配置文件路径">设置主配置文件路径</h4>
<p>使用一个字符串变量表示主配置文件路径</p>
<h4 id="获得主配置文件的输入流">获得主配置文件的输入流</h4>
<p>使用MyBAtis框架中的<code>Resources.getResourceAsStream(config)</code>来获取配置文件输入流，定义InputStream变量来获得返回值。</p>
<h4
id="创建sqlsessionfactorybuilder对象和sqlsessionfactory对象">创建SqlSessionFactoryBuilder对象和SqlSessionFactory对象</h4>
<p>创建一个SqlSessionFactoryBuilder对象，它有一个build方法，将上述的输入流参数传入该方法，得到SqlSessionFactory对象，这个对象是用来生成数据库访问会话的。</p>
<h4 id="设置sql语句的id">设置sql语句的id</h4>
<p>在sql映射文件中，有sql语句id，将namespace和id拼接形成的字符串作为sql语句的id</p>
<h4
id="使用session会话执行sql语句返回结果">使用session，会话执行SQL语句，返回结果</h4>
<p>调用factory的openSession()方法，打开一个会话session，调用会话的selectList方法，将上面的id传入该方法，作为参数。该方法执行查询并返回一个List集合，集合里元素类型就是sql映射文件中resultType类型。</p>
<p><strong>注意：上述的访问数据库的方法，只是其中一种，还有很多其他的重载方法可用。</strong></p>
<h2 id="sql映射文件">SQL映射文件</h2>
<p>该文件是用来写sql语句的，MyBatis框架会执行这些sql</p>
<p>​</p>
<p>基本文件格式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.dao.StudentDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    select * from Blog where id = #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中</p>
<ol type="1">
<li><p>第一行是用来规定xml的版本和字符集。</p></li>
<li><p>mybatis-3-mapper.dtd是约束文件名称，拓展名为dtd。</p>
<p>约束文件的作用：</p>
<p>​
是用来限制、检查当前文件中出现的标签、属性是否符合MyBatis的要求。</p>
<p>很多框架的配置文件中都会用到约束文件。</p></li>
<li><p>mapper</p>
<p>是当前文件的根标签，是必须有的。</p>
<p>namespace：叫做命名空间，唯一值，可以是自定义的字符串，但是应该使用dao接口的全限定名称，例如StudentDao接口，那么namespace就应该等于"org.example.dao.StudentDao"</p></li>
</ol>
<p>在当前文件中，可以使用特定的标签来表示数据库的特定操作。</p>
<ul>
<li><code>&lt;select&gt;</code>：查询操作</li>
<li><code>&lt;update&gt;</code>：更新操作</li>
<li><code>&lt;insert&gt;</code>：插入操作</li>
<li><code>&lt;delete&gt;</code>：删除操作</li>
</ul>
<h3 id="操作">操作</h3>
<h4 id="select">select</h4>
<p><code>&lt;select&gt;</code>表示查询操作。</p>
<p>属性：</p>
<ul>
<li><p>id：要执行的sql语句的唯一标识，MyBatis会使用这个id的值来找到要执行的sql语句。相等于给这个操作语句起了个名。</p>
<p>​ 可以自定义，但是要求使用接口中的方法名称。</p></li>
<li><p>resultType：表示结果类型，即数据库的每一行应该映射为什么Java类型。</p>
<p>​ 值是该类型的全限定名称。</p></li>
</ul>
<p>例子：</p>
<p>在DAO接口中定义查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">selectStudents</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>在映射文件中编写具体查询的sql语句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStudents&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.domain.Student&quot;</span> &gt;</span></span><br><span class="line">    select id, name, email, age from student;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用SqlSession的<code>selectList(String
statement)</code>方法来进行查询，返回值是List集合。selectList有多种重载方法。</p>
<h4 id="insert">insert</h4>
<p>插入操作</p>
<p>语法格式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    insert into tablename values(#&#123;&#125;, #&#123;&#125;, #&#123;&#125;...)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span>    </span><br></pre></td></tr></table></figure>
<p>其中属性id是这个插入操作的唯一标识，应使用DAO接口的对应方法名。</p>
<p>语法格式：<code>#&#123;&#125;</code>代表访问传来的参数对象中的成员变量。</p>
<p>例如：</p>
<p>在DAO接口中定义插入数据方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertStudent</span><span class="params">(Student student)</span>;</span><br></pre></td></tr></table></figure>
<p>参数是Student对象，在映射文件中使用#{}来访问该对象中的成员变量作为实际插入的数据：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertStudent&quot;</span> &gt;</span></span><br><span class="line">    insert into student values (#&#123;id&#125;, #&#123;name&#125;, #&#123;email&#125;, #&#123;age&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用SqlSession的<code>insert(String Statement, Object
parameter)</code>来执行插入语句，第一个参数表示sqlId，第二个表示要传入的参数。insert有两种重载方法。另一种是<code>insert(String
statement)</code>。</p>
<h4 id="update">update</h4>
<p>更新操作。</p>
<p>属性id 和上述一样。</p>
<p>其中同样使用<code>#&#123;&#125;</code>来访问参数对象的成员变量。</p>
<p>例子：</p>
<p>在DAO接口定义更新对象方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateStudent</span><span class="params">(Student student)</span>;</span><br></pre></td></tr></table></figure>
<p>参数Student对象，在映射文件中定义具体sql语句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateStudent&quot;</span> &gt;</span></span><br><span class="line">    update student set age = #&#123;age&#125; where name = #&#123;name&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用SqlSession的<code>update(String statement, Object
parameter)</code>对象执行更新操作。该方法有两种重载形式。另一种是<code>update(String
statement)</code>。</p>
<p>执行结果：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201202101656428.png" alt="image-20201202101656428" style="zoom:40%;" /></p>
<h4 id="delete">delete</h4>
<p>删除操作</p>
<p>属性id 和上面一样。</p>
<p>同样使用<code>#&#123;&#125;</code>访问参数对象成员变量。</p>
<p>例子： DAO接口增加删除方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteStudent</span><span class="params">(Student student)</span>;</span><br></pre></td></tr></table></figure>
<p>映射文件中编写具体删除的sql语句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteStudent&quot;</span> &gt;</span></span><br><span class="line">    delete from student where name = #&#123;name&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用SqlSession的delete方法来执行删除操作。同样有两种重载类型：<code>delete(String
statement, Object parameter)</code>和<code>delete(String
statement)</code>。</p>
<p>执行结果：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201202102209579.png" alt="image-20201202102209579" style="zoom:43%;" /></p>
<h2 id="主配置文件">主配置文件</h2>
<p>基本格式为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/mybatis/example/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>主配置文件放在resources目录中，是xml文件，在头部使用约束文件。它的根元素是<configuration>,主要包含定义别名、配置数据源、mapper文件三个内容。</p>
<p>其中：</p>
<ul>
<li><p><code>&lt;environments&gt;</code>：表示环境配置，即数据库的连接信息。</p>
<p>default属性的值必须和某个environment的id值一样，这个属性值告诉mybatis使用哪个数据库的连接信息</p></li>
<li><p><code>&lt;environment&gt;</code>：表示一个数据库的配置环境。属性id表示该数据库配置的名称，自定义，是一个唯一值</p></li>
<li><p><code>&lt;transactionManager&gt;</code>：表示mybatis使用的事务管理器</p>
<p>type代表类型，有两个可取值:</p>
<ol type="1">
<li>JDBC(表示使用JDBC中的Connection对象的commit、rollback)。默认情况下，MyBatis使用手动提交，即需要在程序中显式的对事务进行提交或回滚。</li>
<li>MANAGED：表示由容器来管理事务的整个生命周期(如Spring容器)。</li>
</ol></li>
<li><p><code>&lt;dataSource&gt;</code>：表示数据源，type代表数据源类型，有三种取值</p>
<ol type="1">
<li>POOLED：使用连接池，MyBatis会创建PooledDataSource实例</li>
<li>UNPOOLED：MyBatis会创建UnPooledDataSource实例</li>
<li>JNDI：PooledDataSource会从JNDI服务上查找DataSource实例，然后返回使用。</li>
</ol></li>
<li><p><code>&lt;property&gt;</code>：表示连接的属性配置，有驱动，url，用户名，密码四个要素。</p>
<p>属性name有driver、url、username、password取值，属性value表示实际的值</p></li>
</ul>
<p>此外，为了方便对数据库连接的管理，数据库连接的四要素一般放在专门的属性文件中，拓展名为properties。MyBatis需要从属性文件中读取这些数据。</p>
<p>同样把属性文件放在resources目录中，名称自定义。</p>
<p>例如: jdbc.properties，文件基本格式为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driver=</span><br><span class="line">jdbc.url=</span><br><span class="line">jdbc.username=</span><br><span class="line">jdbc.password=</span><br></pre></td></tr></table></figure>
<p>然后在主配置文件<configuration>标签下，加入<properties resource = "文件路径" />标签，加载该属性文件。</p>
<p><strong>然后在
<property>标签中的value属性，使用${key}语法格式来获得属性文件中的对应值。</strong></p>
<p>例如:$(jdbc.driver)即可获取驱动。</p>
<p><mappers>标签指定sql应设问句的位置，其中一个<mapper>标签指定一个文件的位置，属性resource就用来指定文件路径。</p>
<p>类路径，即编译后的target/classes目录下开始的路径。</p>
<p>也可以使用<package name="">用来指定包下的所有DAO接口</p>
<p>使<strong>用package的要求：</strong></p>
<ul>
<li><strong>mapper文件和dao接口文件名必须完全一样，包括大小写</strong></li>
<li><strong>mapper文件和dao接口必须在同一目录</strong></li>
</ul>
<h2 id="一个例子">一个例子</h2>
<p>根据之前创建的student表和Student实体类，来使用MyBatis框架访问数据库。</p>
<p>首先创建sql映射文件StudentDao.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.dao.StudentDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStudents&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.domain.Student&quot;</span> &gt;</span></span><br><span class="line">        select id, name, email, age from student;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在resources目录中创建jdbc.properties属性文件和mybatis.xml主配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">url=jdbc:mysql://localhost:3306/test?usrSSL=false&amp;serverTimezone=UTC</span><br><span class="line">username=root</span><br><span class="line">password=*******</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;jdbc.properties&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/example/dao/StudentDao.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在测试类中编写测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">//设置主配置文件路径</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;mybatis.xml&quot;</span>;</span><br><span class="line">      <span class="comment">//获取输入流</span></span><br><span class="line">      <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Resources.getResourceAsStream(config);</span><br><span class="line">      <span class="comment">//创建sqlSessionFactoryBuilder对象，用该对象构建SqlSessionFactoryBuilder对象</span></span><br><span class="line">      <span class="type">SqlSessionFactoryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>();</span><br><span class="line">      <span class="comment">//将输入流变量in传入，构建SqlSessionFactory</span></span><br><span class="line">      <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> builder.build(in);</span><br><span class="line">      <span class="comment">//调用factory方法打开一个会话</span></span><br><span class="line">      <span class="type">SqlSession</span> <span class="variable">session</span> <span class="operator">=</span> factory.openSession();</span><br><span class="line">      <span class="comment">//拼接namespace和id作为sql语句的id</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">sqlId</span> <span class="operator">=</span> <span class="string">&quot;org.example.dao.StudentDao&quot;</span> + <span class="string">&quot;.&quot;</span> + <span class="string">&quot;selectStudents&quot;</span>;</span><br><span class="line"><span class="comment">//将id传入执行方法获得结果List集合</span></span><br><span class="line">      List&lt;Student&gt; list = session.selectList(sqlId);</span><br><span class="line">      list.forEach(sql-&gt; System.out.println(sql));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201201141739513.png" alt="image-20201201141739513" style="zoom:43%;" /></p>
<h2 id="注意">注意</h2>
<ol type="1">
<li></li>
</ol>
<p>默认情况下，Maven编译是不会加上xml、properties等文件的，如果要让Maven加上这些文件，要在pom.xml中的build标签中，加入一个插件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--扫描的目录--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><p>在mybatis.xml文件中加入如下代码，可以将数据库操作日志输出到控制台，方便来查看具体信息。</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure></p></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/10-Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/10-Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">10-Spring常用注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:10 / 修改时间：16:59:37" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:10+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spring常用注解">10-Spring常用注解</h1>
<h2 id="configuration"><span class="citation"
data-cites="Configuration">@Configuration</span></h2>
<p>位置：一般用在类上</p>
<p>作用：表示该类作为一个配置类，配置一些内容</p>
<h2 id="bean"><span class="citation" data-cites="Bean">@Bean</span></h2>
<p>位置：一般用在方法上，<strong>并且该方法所在类是配置类，即被@Configuration注解的类</strong></p>
<p>作用：表示把该方法返回的对象交给Spring容器管理</p>
<h2 id="service"><span class="citation"
data-cites="Service">@Service</span></h2>
<p>位置：用在类上</p>
<p>作用：标注业务层组件</p>
<h2 id="controller"><span class="citation"
data-cites="Controller">@Controller</span></h2>
<p>位置：用在类上</p>
<p>作用：标注控制层组件</p>
<h2 id="repository"><span class="citation"
data-cites="Repository">@Repository</span></h2>
<p>位置：用在类上</p>
<p>作用：标注数据访问层组件，即DAO组件</p>
<h2 id="compinent"><span class="citation"
data-cites="Compinent">@Compinent</span></h2>
<p>位置：用在类上</p>
<p>作用：泛指组件，当组件不好归类，就用该注解进行标注</p>
<h2 id="primary"><span class="citation"
data-cites="Primary">@Primary</span></h2>
<p>位置：用在类上</p>
<p>作用：当自动装配出现多个Bean候选者时，被注解@Primary的Bean将作为首选项。</p>
<h2 id="autowired"><span class="citation"
data-cites="Autowired">@Autowired</span></h2>
<p>位置：用在变量上</p>
<p>作用：默认按类型装配，当出现多个Bean，则再按名称，如还是有多个Bean，并且没有@Primary，那么就会出现错误</p>
<h2 id="resource"><span class="citation"
data-cites="Resource">@Resource</span></h2>
<p>位置：用在变量上</p>
<p>作用：默认按名称装配</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/9-Spring%E5%92%8CWeb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/9-Spring%E5%92%8CWeb/" class="post-title-link" itemprop="url">9-Spring和Web</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:09 / 修改时间：16:59:35" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:09+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spring和web">9-Spring和Web</h1>
<p>在Web项目中使用Spring框架，首先要在web层(这里指Servlet)获取到Spring容器对象。只要获取到了Spring容器，就可以从该容器中获取到Service对象。</p>
<p>那么接下来就要思考在哪里创建Spring容器。</p>
<p>对于一个web应用来说，Spring容器对象只需要一个就可以了。所以很显然不能直接在Servlet中创建Spring容器，因为虽然Servlet是单例多线程，但多个Servlet都需要用到Spring容器，就会创建多个Spring容器。</p>
<p>我们想到，对于一个web应用，全局作用域对象ServletContext也只有一个，所以可以在创建全局作用域对象的时候创建Spring容器，并把Spring容器对象存入ServletContext中。</p>
<p>之前学到了全局作用域的监听器接口ServletContextListener，我们可以使用监听器监听全局作用域，当全局作用域创建的时候同时创建Spring容器，并放入全局作用域对象中。</p>
<p>可以自定义全局作用域监听器接口实现类，也可以使用spring的一个模块spring-web提供的实现类ContextLoaderListener。</p>
<h2 id="使用步骤">使用步骤</h2>
<h3 id="加入依赖">加入依赖</h3>
<p>首先加入spring-web依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3
id="在web配置文件web.xml中注册监听器">在web配置文件web.xml中注册监听器</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    org.springframework.web.context.ContextLoader</span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3
id="在web配置文件web.xml文件中指定spring配置文件路径">在web配置文件web.xml文件中指定spring配置文件路径</h3>
<p>使用<context-param>标签来配置，语法格式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring配置文件路径<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子标签<param-name>的值就是contextConfigLocation，固定不变。<param-value>就是spring配置文件的路径。</p>
<p>ContextLoaderListener会从ServletContext中获取该参数，然后创建spring容器。</p>
<p>注意，如果从ServletContext中获取web.xml初始参数，需要使用的方法是<code>getInitParameter(String
name)</code>，而不是<code>getAttribute(String name)</code>。</p>
<p>如果没有使用<context-param>标签指定spring配置文件路径，那么会默认使用WEB-INF/applicationContext.xml这个路径。</p>
<h4 id="获取spring容器对象">获取Spring容器对象</h4>
<p>获取Spring容器对象有两种方法。</p>
<p>在之前的例子中，Spring容器对应类时ApplicationContext，在web应用中容器对应类时WebApplicationContext，它是ApplicationContext的子类。</p>
<h4 id="从servletcontext中获取">从ServletContext中获取</h4>
<p>Spring容器对象在ServletContext中存放的key为<code>WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE。</code></p>
<p>可以通过这个key，调用ServletContext的<code>getAttribute(String
name)</code>方法获取WebApplicationContext。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">attr</span> <span class="operator">=</span> <span class="string">&quot;WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE&quot;</span>;</span><br><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> (WebApplicationContext) <span class="built_in">this</span>.getServletContext().getAttribute(attr);</span><br></pre></td></tr></table></figure>
<h4
id="通过webapplicationcontextutils获取">通过WebApplicationContextUtils获取</h4>
<p>WebApplicationContextUtils是一个工具类，它有一个<code>getRequiredWebApplicationContext(ServletContext
sc)</code>方法，传入ServletContext参数，返回值就是Spring容器对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> WebApplicationContextUtils.getRequiredWebApplicationContext(sc);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/8-Spring%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/8-Spring%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">8-Spring事务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:08 / 修改时间：16:59:33" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:08+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spring事务">8-Spring事务</h1>
<h2 id="概念">概念</h2>
<p>事务最开始是数据库中的概念，在DAO层。数据库中的事务指一组sql语句的集合，我们希望这些语句都成功或者都失败。</p>
<p>即执行是一致的。当涉及多个表或者多个sql语句的insert，update等，需要保证这些语句都成功，可以使用事务。</p>
<p>事务有四个特性：</p>
<ul>
<li><p>原子性：指事务不可分割，是一个整体</p></li>
<li><p>一致性：事务中的语句要么都执行，要么都不执行。保持一致</p></li>
<li><p>隔离性：该事务的执行不影响其他事务的执行</p></li>
<li><p>持久性：事务执行完以后，永久有效。</p></li>
</ul>
<p>但一般情况，需要将事务提升到业务层，即Service层。这样做是为了能够使用事务的特性来管理具体的业务。</p>
<p>Spring中，通常使用两种方式实现对事务的管理：</p>
<ul>
<li>使用Spring的事务注解管理事务</li>
<li>使用AspectJ的AOP配置管理事务</li>
</ul>
<p>事务处理应放在Service的业务方法上，因为业务方法要运行多个sql语句。</p>
<h2 id="之前数据库事务处理方式的不足">之前数据库事务处理方式的不足</h2>
<ul>
<li>不同数据库访问技术，处理事务的对象、方法不同，JDBC和MyBatis、Hibernate的事务处理各不相同。</li>
<li>需要了解不同数据库访问技术使用事务的原理</li>
<li>掌握多种数据库事务的处理逻辑，什么时候提交事务，什么时候回滚事务</li>
<li>处理事务的多种方法</li>
</ul>
<p>大致总结就是：多种数据库的访问技术，有不同的事务处理的机制、对象和方法。</p>
<p>那么解决不足的方法就是：使用Spring提供的一种处理事务的统一模型，使用统一步骤、方法完成对不同数据库访问技术的事务处理。</p>
<h2 id="spring事务管理">Spring事务管理</h2>
<p>Spring使用事务管理器来管理事务。事务管理器是一个接口，它有众多的实现类。</p>
<p>接口：PlatformTransactionManager,定义了事务方法commit、rollback</p>
<p>实现类：spring把每一种数据库访问技术对应的事务处理类都创建好了。</p>
<p>DateSourceTransactionManager类：使用JDBC或MyBatis进行数据库操作</p>
<p>HibernateTransactionManager类：使用Hibernate进行持久化数据时使用</p>
<p>使用：我们需要告诉spring使用的是哪种数据库访问技术，就是在配置文件中使用<bean>标签声明，创建数据库访问技术对应的类。</p>
<h3 id="spring回滚方式">Spring回滚方式</h3>
<p>Spring事务的默认的回滚方式是：发生运行时异常和error时回滚，发生编译异常时提交。但是，对于编译异常，我们可以手动设置回滚方式。</p>
<p>复习一下错误和异常：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206131613291.png" alt="image-20201206131613291" style="zoom:67%;" /></p>
<h3 id="事务定义接口">事务定义接口</h3>
<p>在创建好<bean>标签后，还需要说明事务的类型。</p>
<p>事务定义接口TransactionDefinition中定义了事务描述相关的三类常量：事务隔离级别、事务传播行为和事务默认超时时限，及对它们的操作。</p>
<h4 id="事务隔离级别">事务隔离级别</h4>
<p>事务的并发问题：
<img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206102734602.png" alt="image-20201206102734602" style="zoom:50%;" /></p>
<p>隔离级别就是用来处理这些问题。</p>
<p>可取五个值，但实际只有四种情况(这四种情况由上到下隔离级别越来越高)：</p>
<ul>
<li>DEFAULT：采用数据库默认事务隔离级别，MySQL默认为REPEATABLE_READ</li>
<li>READ_UNCOMMITED：读未提交，<strong>一个事务可以读取另一个未提交事务的数据</strong>，未解决任何并发问题</li>
<li>READ_COMMITED：读已提交，<strong>一个事务要等到另一个事务提交后，才能读取事务。</strong>解决读脏数据、存在不可重复读和幻读</li>
<li>REPEATABLE_READ：可重复读，<strong>就是在开始读取数据后，不允许修改数据。</strong>解决读脏数据、不可重复读，存在幻读</li>
<li>SERIALIZABLE：串行化，<strong>即事务串行化顺序执行</strong>，不存在并发问题。但是这种级别效率很低，很耗数据库性能，一般不使用</li>
</ul>
<h4 id="事务超时时间">事务超时时间</h4>
<p>表示一个方法最长的执行时间，如果方法执行超过了该时间，事务就回滚。单位是秒，整数。默认为-1.</p>
<p>一般不去管它，使用默认值即可。</p>
<h4 id="事务传播行为">事务传播行为</h4>
<p>事务传播行为是指：处在不同事务的方法在相互调用时，执行期间事务的维护情况。例如：A事务中的方法doSome()调用B事务中的方法doOther()，在调用执行期间事务的维护情况，就是事务传播行为。事务传播行为行为是加在方法上的。</p>
<p>事务传播行为常量都是以PROPAGATION_开头，一共有其中情况</p>
<ul>
<li><strong>PROPAGATION_REQUIRED</strong></li>
<li><strong>PROPAGATION_REQUIRES_NEW</strong></li>
<li><strong>PROPAGATION_SUPPORTS</strong></li>
<li>PROPAGATION_MANDATORY</li>
<li>PROPAGATION_NESTED</li>
<li>PROPAGATION_NEVER</li>
<li>PROPAGATION_NOT_SUPPORTED</li>
</ul>
<p>其中前三个最为常用，只需掌握前三个即可。</p>
<h5 id="propagation_required"><strong>PROPAGATION_REQUIRED</strong></h5>
<p>指定的方法必须在事务内执行，若当前存在事务，就加入到当前事务；若当前没有事务，则必须创建一个事务，然后加入到新创建的事务中。<strong>总而言之，指定了该传播行为的方法，必须在事务内执行。</strong></p>
<p>例如：如果该传播行为加在A方法上，在B方法中调用A方法。如果，B方法是在事务内执行的，那么A方法就加入到该事务；如果B方法没有在事务内执行，那么在A方法内会创建一个事务，并在其中执行。</p>
<h5 id="propagation_supports"><strong>PROPAGATION_SUPPORTS</strong></h5>
<p>指定的方法支持当前事务，但如果没有事务，也可以以非事务方式执行。也就是说，指定了该传播行为的方法，如果执行时有事务，就在事务内执行，如果没有，同样可以在无事务下运行。</p>
<h5
id="propagation_requires_new"><strong>PROPAGATION_REQUIRES_NEW</strong></h5>
<p>总是新建一个事务，如果当前存在事务，就将该事务挂起，直到新事务执行完毕。</p>
<h3 id="spring事务管理使用">Spring事务管理使用</h3>
<p>管理事务的是事务管理器接口和它的实现类。</p>
<p>使用时，有以下几个步骤：</p>
<ul>
<li>指定要使用的事务管理器实现类，使用<bean>标签</li>
<li>指定哪些类的哪些方法需要加入事务的功能</li>
<li>指定隔离级别、传播行为和超时时间</li>
</ul>
<h3 id="使用注解管理事务">使用注解管理事务</h3>
<p>通过使用@Transactional注解方式，该注解是spring框架提供的，可以将事务植入到相应public方法中，实现事务管理。</p>
<p><span class="citation"
data-cites="Transactional注解的可选属性如下">@Transactional注解的可选属性如下</span>：</p>
<ul>
<li><p>propagation：用于设置事务传播属性，属性类型为Propagation枚举。默认值为PROPAGATION_REQUIRED</p></li>
<li><p>isolation：用于设置事务隔离级别，属性类型为Isolation枚举。默认值为ISLLATION_DEFAULT</p></li>
<li><p>readOnly：用于设置该方法对于数据库操作是否是只读的。属性为boolean，默认值为false。当查询操作时，可设为true</p></li>
<li><p>timeout：设置本操作与数据库连接的超时时限。单位为秒，类型为int，默认值为-1，即没有时限。</p></li>
<li><p>rollbackFor：指定需要回滚的异常类。即方法抛出这些异常类，就需要回滚。类型为Class[]，默认值为空数组。当只有一个异常类时，可以不使用数组。</p></li>
<li><p>rollbackForClassName：指定需要回滚的异常类类名，类型为String[]，默认值为空数组。当只有一个异常类时，可以不使用数组</p></li>
<li><p>noRollbackFor：指定不需要回滚的异常类，即抛出这些异常时，不需要回滚。类型为Class[]，默认值为空数组。当只有一个异常类时，可以不使用数组。</p></li>
<li><p>noRollbackForClassName：指定需要不回滚的异常类类名，类型为String[]，默认值为空数组。当只有一个异常类时，可以不使用数组</p></li>
</ul>
<p><strong>注意：</strong></p>
<p><strong><span class="citation"
data-cites="Transactional注解">@Transactional注解</span></strong></p>
<ul>
<li><p><strong>若用在方法上，只能用在public方法上。对于非public方法，如果加上@Transactional注解，spring不会报错，但不会将指定事务植入到该方法。因为Spring会忽略掉所有非public方法的@Transactional注解。</strong></p></li>
<li><p><strong>若@Transactional注解用在类上，则表示该类的所有public方法都植入事务。</strong></p></li>
<li><p>rollbackFor：表示发生指定的异常一定回滚</p>
<p>处理机制是：</p>
<ol type="1">
<li>spring框架会首先检查抛出的异常是否在rollbackFor的属性值中，如果在，那么不管是什么类型异常，一定回滚</li>
<li>如果不在rollbackFor中，那么spring会判断异常是不是RuntimeException，如果是一定回滚。</li>
</ol>
<p><strong>所以，rollbackFor其实只管编译时异常，而不需要管运行时异常。因为抛出运行时异常一定回滚。</strong></p></li>
</ul>
<h4 id="使用步骤">使用步骤</h4>
<ol type="1">
<li><p>在配置文件中声明事务管理器，就是使用<bean>标签声明事务管理器对象，属性dataSource就是创建的数据源</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSourcce&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>开启注解驱动，就是告诉spring框架，要使用注解的方式管理事务。</p>
<p>Spring使用AOP机制，创建@Transactional所在类的代理对象，给方法加入事务的功能。</p>
<p>在业务方法执行之前，开启事务，业务方法之后，提交或回滚事务，使用的是AOP的环绕通知。</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>注意：这里有四个同名的annotation-driven对应的命名空间，应该选择这个</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br></pre></td></tr></table></figure></p></li>
<li><p>业务层public方法加上事务属性，即在方法上加上@Transactional注解</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(</span><br><span class="line">        propagation = Propagation.REQUIRED,</span><br><span class="line">        isolation = Isolation.DEFAULT,</span><br><span class="line">        readOnly = false,</span><br><span class="line">        rollbackFor = &#123;...&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>可以这样写，也可以直接写<code>@Transactional</code>，不加括号里的内容。则代表使用默认值，rollbackFor默认抛出运行时异常时回滚事务。</p></li>
</ol>
<h2 id="一个完整的例子">一个完整的例子</h2>
<h3 id="创建两个表">创建两个表</h3>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206130953994.png" alt="image-20201206130953994" style="zoom:50%;" /></p>
<h3 id="加入pom依赖">加入pom依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建实体类">创建实体类</h3>
<p>两个实体类，Goods和Sale</p>
<p>Goods：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer amount;</span><br><span class="line">    <span class="keyword">private</span> Float price;</span><br><span class="line">    <span class="comment">//构造器</span></span><br><span class="line">    <span class="comment">//set和get方法</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>Sale：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sale</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer gid;</span><br><span class="line">    <span class="keyword">private</span> Integer nums;</span><br><span class="line">    <span class="comment">//构造器</span></span><br><span class="line">    <span class="comment">//set和get方法</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h3 id="创建接口">创建接口</h3>
<p>同样有两个，操作Goods的GoodsDao接口，操作Sale的SaleDao接口。</p>
<p>GoodsDao：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateGoods</span><span class="params">(Goods goods)</span>;</span><br><span class="line">    Goods <span class="title function_">selectGoods</span><span class="params">(Integer goodsId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SaleDao：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SaleDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertSale</span><span class="params">(Sale sale)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建映射文件">创建映射文件</h3>
<p>一个接口一个映射文件</p>
<p>GoodsDao.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.dao.GoodsDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateGoods&quot;</span>&gt;</span></span><br><span class="line">        update goods  set amount = amount - #&#123;amount&#125; where id=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectGoods&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.domain.Goods&quot;</span>&gt;</span></span><br><span class="line">        select * from goods where id = #&#123;goodsId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SaleDao.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.dao.SaleDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertSale&quot;</span>&gt;</span></span><br><span class="line">        insert into sale(gid, nums) values (#&#123;gid&#125;,#&#123;nums&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义异常类">自定义异常类</h3>
<p>定义一个库存不足抛出的异常类NotEnoughException：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotEnoughException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NotEnoughException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NotEnoughException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建service接口和实现类">创建Service接口和实现类</h3>
<p>接口中只定义一个buy方法，代表买商品，需要操作两个表，在Sale中加入销售记录，更新Goods表中对应商品库存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BuyGoodsService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goodsId:购买商品的编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums:购买商品的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">buy</span><span class="params">(Integer goodsId, Integer nums)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuyGoodsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BuyGoodsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GoodsDao goodsDao;</span><br><span class="line">    <span class="keyword">private</span> SaleDao saleDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGoodsDao</span><span class="params">(GoodsDao goodsDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.goodsDao = goodsDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSaleDao</span><span class="params">(SaleDao saleDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.saleDao = saleDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加事务注解，也可以直接加上@Transactional，效果一样</span></span><br><span class="line">    <span class="meta">@Transactional(</span></span><br><span class="line"><span class="meta">            propagation = Propagation.REQUIRED,</span></span><br><span class="line"><span class="meta">            isolation = Isolation.DEFAULT,</span></span><br><span class="line"><span class="meta">            readOnly = false,</span></span><br><span class="line"><span class="meta">            rollbackFor = &#123;NullPointerException.class, NotEnoughException.class&#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//这个方法先插入销售记录，而不是先判断存不存在该商品和商品库存，是为了更明显的显示事务回滚和提交</span></span><br><span class="line">    <span class="comment">//如果没有该注解，那么当抛出异常，销售记录依然存在</span></span><br><span class="line">    <span class="comment">//加上注解，抛出了异常，事务回滚，销售记录会删除</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buy</span><span class="params">(Integer goodsId, Integer nums)</span> &#123;</span><br><span class="line">        <span class="type">Sale</span> <span class="variable">sale</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sale</span>();</span><br><span class="line">        sale.setGid(goodsId);</span><br><span class="line">        sale.setNums(nums);</span><br><span class="line">        saleDao.insertSale(sale);</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> goodsDao.selectGoods(goodsId);</span><br><span class="line">        <span class="keyword">if</span>(goods == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;没有该商品&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(goods.getAmount() &lt; nums) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotEnoughException</span>(<span class="string">&quot;商品库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">buyGoods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>();</span><br><span class="line">        buyGoods.setId(goodsId);</span><br><span class="line">        buyGoods.setAmount(nums);</span><br><span class="line">        goodsDao.updateGoods(buyGoods);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写spring配置文件">编写spring配置文件</h3>
<p>省略了mybatis配置文件和属性文件，因为非常简单。</p>
<p>spring配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.alibaba.com/schema/stat http://www.alibaba.com/schema/stat.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;druid&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.maxActive&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;druid&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis.xml&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.example.dao&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;buyGoodsService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.Service.impl.BuyGoodsServiceImpl&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;goodsDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;goodsDao&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;saleDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;saleDao&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--创建事务管理器对象--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;druid&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">&lt;!--事务驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试类">编写测试类</h3>
<p>只测试抛出异常的情况。抛出两个异常，事务都会回滚，情况差不多，只测试一个</p>
<h4 id="抛出notenoughexception异常">抛出NotEnoughException异常</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBuyGoodsService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">BuyGoodsService</span> <span class="variable">buyGoodsService</span> <span class="operator">=</span> (BuyGoodsService) applicationContext.getBean(<span class="string">&quot;buyGoodsService&quot;</span>);</span><br><span class="line">    buyGoodsService.buy(<span class="number">1001</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>库存不够，运行结果：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206132520782.png" alt="image-20201206132520782" style="zoom:50%;" /></p>
<p>同时Sale表和Goods表并没有发生变化：
<img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206132559732.png" alt="image-20201206132559732" style="zoom:50%;" /></p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201206132607728.png" alt="image-20201206132607728" style="zoom:50%;" /></p>
<h2 id="使用aspectj的aop配置管理事务">使用AspectJ的AOP配置管理事务</h2>
<p>使用注解配置事务代理方式的不足是，当有很多类、很多方法需要配置时，需要大量的配置事务，非常麻烦。</p>
<p>这时候，使用@AspectJ的AOP来进行配置。在spring配置文件中声明类、方法需要的事务，使用这种方法，业务逻辑和事务配置完全分离。</p>
<p>适合大型项目。前面那一种适合中小型项目。</p>
<h3 id="使用步骤-1">使用步骤</h3>
<h3 id="声明事务管理器对象">声明事务管理器对象</h3>
<p>只要有事务管理，就要声明事务管理器对象，这个和前面是一样的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置事务属性">配置事务属性</h3>
<p>因为不使用注解来配置事务，就需要在配置文件中进行配置。</p>
<p>使用<code>&lt;tx:advice&gt;</code>标签，事务通知来进行配置</p>
<p>语法格式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;&quot;</span> <span class="attr">isolation</span>=<span class="string">&quot;&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;&quot;</span> <span class="attr">rollback-for</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中</p>
<p><code>&lt;tx:advice&gt;</code>的id属性用来标识该标签，是一个自定义的唯一值。</p>
<p>transaction-manager属性是事务管理器的id。</p>
<p><code>&lt;tx:attributes&gt;</code>中有<code>&lt;tx:method&gt;</code>标签，是用来给具体的方法配置事务，可以有多个，分别给不同方法设置事务属性。</p>
<p><code>&lt;tx:method&gt;</code>中：</p>
<ul>
<li>name：方法名称，值有两种类型
<ol type="1">
<li>完整的方法名称，不带包和类</li>
<li>使用通配符*表示任意字符</li>
</ol></li>
<li>propagation：事务传播行为</li>
<li>isolation：事务隔离级别</li>
<li>read-only：是否只读</li>
<li>no-rollback-for：回滚异常类，值是异常类的全限定类名，多个类用
<code>,</code>分开</li>
</ul>
<p>注意：如果使用通配符配置方法名称，应该设置同一类的方法名称有共同的单词，便于通配符设置。</p>
<h3 id="配置aop">配置AOP</h3>
<p>配置好不同方法事务属性后，可以发现我们并没有指定是哪个包哪个类的方法。就是说，如果有多个类都有同一个方法，应该使用哪个方法。</p>
<p>那么下面就需要配置AOP，来指定</p>
<p>语法格式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution()&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中：
<strong>标签<code>&lt;aop:pointcut&gt;</code>用来设置切入点，id用来唯一标识该切入点，expression属性就是切入点表达式。用来指定哪些包的哪些类使用事务。</strong></p>
<p><strong>标签<code>&lt;aop:advisor&gt;</code>用来将前面的事务通知标签<code>&lt;tx:advice&gt;</code>和切入点pointcut标签连接起来。两个属性值都是id值</strong></p>
<h3 id="例子">例子</h3>
<p>在之前的例子基础上，修改一下</p>
<h4 id="配置事务管理器对象">配置事务管理器对象</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;druid&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="配置事务通知">配置事务通知</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;advice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="配置aop-1">配置AOP</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;service&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* *.*.service..*.*(..))&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;advice&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;service&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>切入点表达式代表，service之前有两个包，service之后的<code>..</code>代表service包和子包</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/7-Spring%E9%9B%86%E6%88%90MyBatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/7-Spring%E9%9B%86%E6%88%90MyBatis/" class="post-title-link" itemprop="url">7-Spring集成MyBatis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:07 / 修改时间：16:59:30" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:07+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spring集成mybatis">7-Spring集成MyBatis</h1>
<h2 id="mybatis使用步骤">MyBatis使用步骤</h2>
<p>先来回顾以下MyBatis的使用步骤：</p>
<ol type="1">
<li>创建DAO接口</li>
<li>创建实体类</li>
<li>创建映射文件</li>
<li>创建MyBatis主配置文件</li>
<li>使用SqlSessionFactory创建出SqlSession对象(也在主配置文件中)</li>
<li>使用SqlSession对象获得dao接口的实现类对象</li>
<li>执行数据库操作</li>
</ol>
<h2 id="集成到spring后需要的改动">集成到Spring后需要的改动</h2>
<p>那么将MyBatis集成到Spring中以后。需要改动的有：</p>
<ul>
<li>主配置文件中不再需要数据源的配置，数据源要交给Spring容器来管理，在spring配置文件中配置。</li>
<li>对mapper文件的注册，应该使用<package />标签，即只需要给出mapper映射文件所在的包。因为mapper文件的名称和DAO接口名称相同。因此使用这种方式的好处是，若有多个映射文件，配置也不需要修改。当然也可以使用原来的<resource />标签</li>
<li>SqlSessionFactory对象不需要我们来创建，也交给spring容器。</li>
<li>DAO对象同样交给spring容器。</li>
</ul>
<p>因此，需要让spring创建的对象有：</p>
<ul>
<li>独立的连接池类对象，不使用MyBatis默认的连接池，而使用阿里的Druid连接池</li>
<li>SqlSessionFactory对象</li>
<li>dao对象</li>
</ul>
<p><strong>注意：MyBatis集成到Spring后，默认是自动提交事务，不需要写<code>sqlSession.comit();</code>。</strong></p>
<h2
id="mybatis集成到spring后使用步骤">MyBAtis集成到Spring后使用步骤</h2>
<ol type="1">
<li><p>新建Maven项目</p></li>
<li><p>加入maven依赖</p>
<ul>
<li>spring依赖</li>
<li>mybatis依赖</li>
<li>mybatis和spring集成的依赖</li>
<li>mysql驱动依赖</li>
<li>spring事务的依赖</li>
</ul></li>
<li><p>创建实体类</p></li>
<li><p>创建dao接口</p></li>
<li><p>创建mapper文件</p></li>
<li><p>创建myBatis主配置文件</p></li>
<li><p>创建Service接口和实现类，实现类成员变量是dao对象</p></li>
<li><p>创建spring配置文件：声明将mybatis的对象交给spring创建，有：</p>
<ul>
<li>数据源</li>
<li>SqlSessionFactory</li>
<li>DAO对象</li>
<li>自定义的Service对象</li>
</ul></li>
<li><p>编写测试代码，获取Service对象，通过service调用dao来操作数据库</p></li>
</ol>
<h2 id="配置数据源">配置数据源</h2>
<p>首先在spring配置文件applicationContext.xml文件中配置数据源，查询druid的github官网，可以看到通用配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc_url&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc_user&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc_password&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stat&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;300000&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnBorrow&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnReturn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;poolPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxOpenPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;asyncInit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中属性
<code>init-method="init"</code>和<code>destory-method="close"</code>是固定的，这两个方法是在DruidDataSource中写好的。</p>
<p>在上面的配置中，通常只需要配置url、username、password和maxActive。</p>
<p>其中maxActive是设置最大有多少连接数。</p>
<p>Druid会自动根据url识别驱动类名，所以不需要配置driver。</p>
<h2 id="创建sqlsessionfactory对象">创建SqlSessionFactory对象</h2>
<p>在spring文件中配置SqlSessionFactory对象。</p>
<p>之前创建SqlSessionFactory对象，只需要MyBatis配置文件，但是现在把数据源的配置挪到了Spring配置文件中，所以需要两部分，一是Spring配置的数据源，二是mybatis配置文件。</p>
<p>格式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中，第一个<property>的ref属性是上面配置数据源的id</p>
<p>第二个<property>标签，是指定mybatis配置文件路径的。<strong>但是需要使用value属性，并且要加上<code>classpath:</code></strong></p>
<p>在后面写上mybatis的配置文件路径。</p>
<h2 id="创建dao接口对象">创建DAO接口对象</h2>
<p>将创建dao接口对象也交给Spring容器，在配置文件中进行配置。</p>
<p>传统创建DAO对象，需要使用SqlSession对象，调用它的getMapper()方法，并把接口的类作为参数传给该方法。</p>
<p>那么在配置时，同样需要这几项。</p>
<p>使用MapperScannerConfigurer类：它会在内部多次调用getMapper生成多个dao接口的代理对象</p>
<p>语法格式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>该bean不需要id属性。</strong></p>
<p>其中，第一个<property>标签，
指定的是SqlSessionFactory，值应该是之前创建的SqlSessionFactory的id</p>
<p>第二个<property>标签，指定的是DAO接口所在的包名，MapperScannerConfigurer会扫描这个包的每个接口，调用getMapper方法创建每个接口的代理对象，也就是DAO对象。</p>
<p><strong>创建的dao对象的名字是接口名的首字母小写。</strong></p>
<h2 id="创建service接口和实现类">创建Service接口和实现类</h2>
<p>在service包下，创建表的service接口。并在service.impl包下，创建对应实现类。在实现类里定义dao接口对象成员变量，然后不同方法对应数据库的操作。</p>
<h2 id="一个例子">一个例子</h2>
<p>首先创建实体类Student：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">//构造器</span></span><br><span class="line">    <span class="comment">//set和get方法</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>在dao包中创建DAO接口StudentDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">insertStudent</span><span class="params">(Student student)</span>;</span><br><span class="line">    List&lt;Student&gt; <span class="title function_">selectStudent</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建映射文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.dao.StudentDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertStudent&quot;</span>&gt;</span></span><br><span class="line">        insert into student values (#&#123;id&#125;, #&#123;name&#125;, #&#123;email&#125;, #&#123;age&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStudent&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.domain.Student&quot;</span>&gt;</span></span><br><span class="line">        select * from student</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建MyBatis主配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--输出日志到控制台--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--设置别名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;org.example.domain&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--映射文件配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;org.example.dao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建service接口和实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">addStudent</span><span class="params">(Student student)</span>;</span><br><span class="line">    List&lt;Student&gt; <span class="title function_">selectStudents</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StudentDao studentDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStudentDao</span><span class="params">(StudentDao studentDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.studentDao = studentDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">addStudent</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> studentDao.insertStudent(student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">selectStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Student&gt; list = studentDao.selectStudent();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建spring配置文件applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;druid&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;*******&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--创建SqlSessionFactory对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;druid&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis.xml&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--创建dao接口代理对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.example.dao&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.service.impl.StudentServiceImpl&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;studentDao&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectStudents</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">StudentService</span> <span class="variable">studentService</span> <span class="operator">=</span>(StudentService) applicationContext.getBean(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;Student&gt; list = studentService.selectStudents();</span><br><span class="line">    <span class="keyword">for</span>(Student stu: list) &#123;</span><br><span class="line">        System.out.println(stu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAddStudent</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">StudentService</span> <span class="variable">studentService</span> <span class="operator">=</span>(StudentService) applicationContext.getBean(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line">    <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">1012</span>, <span class="string">&quot;林冲&quot;</span>, <span class="string">&quot;linchong@qq.com&quot;</span>, <span class="number">35</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> studentService.addStudent(stu);</span><br><span class="line">    System.out.println(<span class="string">&quot;影响行数为：&quot;</span> + num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行查询操作，运行结果为：
<img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201204155239728.png" alt="image-20201204155239728" style="zoom:50%;" /></p>
<p>执行插入操作，运行结果为：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201204155317439.png" alt="image-20201204155317439" style="zoom:50%;" /></p>
<h2 id="使用属性文件">使用属性文件</h2>
<p>使用properties属性文件来配置数据库连接信息，在spring配置文件中引用配置文件。</p>
<p>首先加入在spring配置文件中加入命名空间：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br></pre></td></tr></table></figure>
<p>然后使用<code>&lt;context:property-placeholder location="classpath:"
/&gt;</code></p>
<p>标签来设置属性文件的路径</p>
<p>最后通过<code>$&#123;属性文件中设置的key&#125;</code>来进行访问</p>
<p>例子：</p>
<p>设置路径：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;druid&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.max&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/6-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86AOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/6-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86AOP/" class="post-title-link" itemprop="url">6-动态代理AOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:06 / 修改时间：16:59:28" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:06+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="动态代理aop">6-动态代理AOP</h1>
<h2 id="简介">简介</h2>
<p>​ AOP(Aspect Orient
Programming)，面向切面编程，是一种可以通过运行期间动态代理实现程序功能的统一维护的一种技术。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重写性，同时提高了开发效率。</p>
<p>​
具体来说，面向切面编程就是将交叉业务逻辑封装成切面，利用AOP容器的功能将切面植入到主业务逻辑中，交叉业务逻辑是指，通用的、与主业务逻辑无关的代码，例如日志，缓存，安全检查等。</p>
<p>​
AOP底层，采用的就是动态代理模式，采用了两种代理：jdk的动态代理，和CGLIB的动态代理。</p>
<p>​
AOP实际就是动态代理的规范化，把动态代理的实现步骤、方式定义好，开发人员使用统一的方式实现动态代理。</p>
<h3 id="jdk动态代理">jdk动态代理</h3>
<p>​
使用jdk的Proxy、Method和InvocationHandler创建代理对象，<strong>jdk动态代理要求目标类必须实现接口。</strong></p>
<h3 id="cglib动态代理">CGLIB动态代理</h3>
<p>​
是第三方的工具库，创建代理对象，原理是继承。<strong>通过继承目标类，来创建子类，子类就是代理对象。</strong>这种方式要求目标类不能是final，方法也不能是final。</p>
<h2 id="切面">切面</h2>
<h3 id="一些术语">一些术语</h3>
<ol type="1">
<li><strong>Aspect：切面，表示增强的功能。一般是一个类，也叫作切面类。完成一个非业务功能。常见有日志，事务，权限验证。</strong></li>
<li>JoinPoint：连接点，连接业务方法和切面的位置，就是目标类的业务方法。</li>
<li><strong>Pointcut：切入点，指多个连接点方法的集合，多个方法。</strong>
<ul>
<li><strong>执行目标对象方法，动态的植入切面代码</strong></li>
<li><strong>通过切入点表达式，指定拦截哪些类的哪些方法，给指定的类在运行的时候植入切面类代码</strong></li>
</ul></li>
<li><strong>切入点表达式：指定哪些类的哪些方法被拦截，即被植入切面类代码</strong></li>
<li>目标对象：给哪个类增加功能，那么这个类就是目标对象</li>
<li>Advice：通知，通知表示切面功能指向的时间，在目标方法之前还是之后。</li>
</ol>
<h3 id="切面的三个关键要素">切面的三个关键要素</h3>
<ol type="1">
<li>切面的功能代码，也就是切面能干什么</li>
<li>切面的执行位置，使用Pointcut来表示，也就是切面代码在哪个位置</li>
<li>切面的执行时间，使用Advice表示时间，在目标方法之前还是之后。</li>
</ol>
<h2 id="aop的实现">AOP的实现</h2>
<p>AOP是动态代理的一个规范化。</p>
<p>AOP的技术实现框架：</p>
<ol type="1">
<li>spring：spring在内部实现了AOP规范，Spring主要在事务处理中使用AOP，在项目开发中很少使用Spring的AOP实现，因为比较笨重。</li>
<li>AspectJ：一个开源的框架，专门做AOP。Spring框架中集成了aspectj框架，通过spring就可以使用aspectj的功能。</li>
</ol>
<p>aspectj框架实现AOP有两种方式：</p>
<ul>
<li>使用XML的配置文件</li>
<li>使用注解，常用。</li>
</ul>
<h2 id="aspectj">AspectJ</h2>
<h3 id="aspectj中的几个常用类">AspectJ中的几个常用类</h3>
<h4 id="joinpoint接口">JoinPoint接口</h4>
<p>JoinPoint是Aspectj框架的一个类，表示切入点，它包含被执行的方法的一些信息，例如参数，方法修饰符等等。</p>
<p>在使用通知注解拦截目标方法后，可以在被注解方法签名中加上该参数，来获取被拦截的方法的一些信息。</p>
<p>常用方法：</p>
<ul>
<li><code>Signature
getSignature()</code>：获取封装了署名信息的对象，该对象可以获取到目标方法名，所属类的Class等信息</li>
<li><code>Object[] getArgs()</code>：获取传入目标方法的参数对象</li>
<li><code>Object getTarget()</code>：获取被代理的对象</li>
<li><code>Object getThis()</code>：获取代理对象</li>
</ul>
<h4 id="proceedingjoinpoint接口">ProceedingJoinPoint接口</h4>
<p>该接口是JoinPoint的子接口，只在环绕通知后的方法参数中使用。</p>
<p>除了上述方法，还有一个proceed的方法，用来执行目标方法。</p>
<h3 id="aspectj的切入点表达式">aspectj的切入点表达式</h3>
<p>AspectJ定义了专门的表达式用于指定切入点，表达式的原型是：</p>
<p>​ <code>execution(modifiers-pattern? ret-type-pattern
declaring-type-pattern?
name-pattern(param-pattern)  throws-pattern?)</code></p>
<p>​ 解释：</p>
<ul>
<li>modifiers-pattern：访问权限类型</li>
<li><strong>ret-type-pattern：返回值类型</strong></li>
<li>declaring-type-pattern：包名类名</li>
<li><strong>name-pattern(param-pattern)：方法名(参数类型和参数个数)</strong></li>
<li>thorws-pattern：抛出异常类型</li>
</ul>
<p>​ ？代表可选的部分</p>
<p>​ 加粗代表必须部分</p>
<p>用中文来表达就是：</p>
<p><code>execution(访问权限  方法返回值   方法声明(参数)
异常类型)</code></p>
<p>各部分使用空格分开，在其中可以使用以下符号</p>
<ul>
<li>*：0至多个任意字符</li>
<li>..
：用在方法参数中，表示任意多个参数；用在包名后，表示当前包及其子包路径</li>
<li>+：用在类名后，表示当前类及其子类；用在接口后，表示当前接口及其实现类</li>
</ul>
<p>例子：</p>
<ul>
<li>execution(public * *(..))：指定切入点为：任意的公共方法</li>
<li>execution(* set*(..))：指定切入点为：任意一个以“set”开始的方法</li>
<li>execution(* com.exy.service. * .
*(..))：指定切入点为com.exy.service包中任意一个类的任意一个方法</li>
</ul>
<h3 id="aspectj通知注解">AspectJ通知注解</h3>
<p>所有通知的方法都包含一个JoinPoint类型参数，就是一个切入点表达式。</p>
<h4 id="before"><span class="citation"
data-cites="Before">@Before</span></h4>
<p>​ 在目标方法执行之前执行。</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143540935.png" alt="image-20201129143540935" style="zoom:50%;" /></p>
<h4 id="afterreturning"><span class="citation"
data-cites="AfterReturning">@AfterReturning</span></h4>
<p>在目标方法执行之后执行，所以可以获取到目标方法的返回值。该注解的returning属性就是用于指定接收方法返回值的变量名的。所以被注解为后置通知的方法，除了可以包含JoinPoint参数(<strong>该参数必须放在被注解方法的第一个参数位置</strong>)外，还可以包含用于接收返回值的变量，该变量最好为Object类型。</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143712141.png" alt="image-20201129143712141" style="zoom:50%;" /></p>
<h4 id="around"><span class="citation"
data-cites="Around">@Around</span></h4>
<p>在目标方法之前或之后执行。<strong>被注解为环绕增强方法要有返回值，推荐使用Object类型，</strong>并且方法可以包含一个ProceedingJoinPoint类型的参数，接口ProceedingJoinPoint有一个proceed方法，用于执行目标方法，若目标方法有返回值，那么该方法的返回值就是目标方法返回值，最后环绕增强方法将返回值返回。该增强方法实际是拦截了目标方法的执行。</p>
<p>环绕通知实际就等同于是jdk的动态代理。</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143222572.png" alt="image-20201129143222572" style="zoom:43%;" /></p>
<p>因为目标方法是在被注解方法中，调用ProceedingJoinPoint的proceed方法执行的，所以被注解方法可以影响目标方法的执行，例如只在参数等于某个值或不等于某个值时执行。</p>
<p>例子：</p>
<p>doAround方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doAround</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;执行doAround方法,name为:&quot;</span> + name);</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切面类中的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(value = &quot;execution(* doAround(..))&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">myAround</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">       Object[] args = pjp.getArgs();</span><br><span class="line">       <span class="comment">//判断传入参数是否为空，并且长度是否大于零</span></span><br><span class="line">       <span class="keyword">if</span>(args != <span class="literal">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) args[<span class="number">0</span>];</span><br><span class="line">           <span class="comment">//如果等于Jack，那么就执行目标方法，否则额拦截该方法</span></span><br><span class="line">           <span class="keyword">if</span>(name.equals(<span class="string">&quot;Jack&quot;</span>)) &#123;</span><br><span class="line">               pjp.proceed();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;方法被拦截，doAround方法没有执行!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201201094811143.png" alt="image-20201201094811143" style="zoom:33%;" /><img
src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201201094837260.png"
alt="image-20201201094837260" /></p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201201094857381.png" alt="image-20201201094857381" style="zoom:33%;" /></p>
<h4 id="afterthrowing"><span class="citation"
data-cites="AfterThrowing">@AfterThrowing</span></h4>
<p>在目标方法抛出异常后执行，该注解的throwing属性用于指定所发生的的异常类对象，被注解为异常通知的方法可以包含JoinPoint参数和Throwable参数，参数名称为thorwing指定的名称，表示发生异常的对象。</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143432571.png" alt="image-20201129143432571" style="zoom:53%;" /></p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143504626.png" alt="image-20201129143504626" style="zoom:50%;" /></p>
<h4 id="after"><span class="citation"
data-cites="After">@After</span></h4>
<p>无论方法是否抛出异常，该增强方法都会执行。</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129143808737.png" alt="image-20201129143808737" style="zoom:50%;" /></p>
<h3 id="pointcut">Pointcut</h3>
<p>​
当较多的通知增强方法使用相同的execution切入点表达式时，编写、维护比较麻烦。Aspectj提供了@Pointcut注解，来定义execution切入点表达式。</p>
<p>​
用法是，将@Pointcut注解在一个方法之上，<strong>以后所有的execution的value属性值都可以使用该方法名作为切入点</strong>，代表的就是@Pointcut定义的切入点，使用@Pointcut注解的方法一般使用private标识，没有实际作用。</p>
<p>​ 实际上使用@Pointcut，就相当于定义了一个变量，可以重复使用。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(value = &quot;execution(* *..service.*.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mypointcut</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>那么在之后使用切入点表达式就可以直接写<code>@After(value =
"mypointcut()")</code>即可。</p>
<h2 id="使spring-aop开发步骤aspectj">使⽤Spring
AOP开发步骤(Aspectj)</h2>
<h3 id="引入aop相关jar文件">引入AOP相关jar文件</h3>
<ul>
<li>spring-aop--3.2.5.RELEASE.jar</li>
<li>aopalliance.jar</li>
<li>aspectjweaver.jar</li>
<li>aspectjrt.jar</li>
</ul>
<p>其实就是引入spring依赖和aspectj依赖。</p>
<h3 id="注解式实现aop编程">注解⽅式实现AOP编程</h3>
<p>我们之前⼿动的实现AOP编程是需要⾃⼰来编写代理⼯⼚的，现在有了Spring，就不需要我们⾃⼰写代
理⼯⼚了。Spring内部会帮我们创建代理⼯⼚。也就是说，不⽤我们⾃⼰写代理对象了。
因此，我们只要关⼼<strong>切⾯类、切⼊点、编写切⼊表达式指定拦截什么⽅法就可以了！</strong></p>
<h4 id="创建切面类">创建切面类</h4>
<p>​
其实就是普通类，需要在类上面加入<code>@Aspect</code>注解，来表明它是个切面类。</p>
<p>​
在类中定义方法，方法就是切面要执行的功能代码，在方法的上面加上aspectj的通知注解，例如<code>@Before</code>或者<code>@After</code>，并且需要指定切入点表达式execution()</p>
<p>​ 其中在切面类中定义方法，该方法有限制：</p>
<ul>
<li><p>必须是公共方法，public</p></li>
<li><p>方法没有返回值，<span class="citation"
data-cites="Around除外">@Around除外</span></p></li>
<li><p>方法名称自定义</p></li>
<li><p>方法可以有参数，也可以没有</p>
<p>如果有，那么参数不是自定义的，有几个参数类型可以使用</p>
<p>上面已经写了通知注解，除了切入点表达式参数。</p>
<p>如果有其他参数，那么被注解的方法也要有相应参数，</p>
<p>例如注解<code>@AfterReturning(value = "execution(* *(..))",
returning="result")</code>，有一个returning参数，参数名为result，代表目标方法执行后的返回值，那么在被注解的方法签名中也要有参数<code>Object
result</code>，参数名必须相同。</p>
<p>其他例如异常通知也是这样。</p>
<p>被注解方法本身还可以有JoinPoint参数。</p>
<p>被注解的方法的参数不需要主动赋值，是aspectj框架自动赋值的。</p></li>
</ul>
<h4 id="创建spirng配置文件">创建spirng配置文件</h4>
<p>​ 在配置文件中声明对象，把对象统一交给容器管理。</p>
<p>​ 声明对象可以用注解，也可以用XML配置。</p>
<p>​
并且声明aspectj框架中的自动代理生成器标签<code>&lt;aop:aspectj-autoproxy&gt;</code>，这个标签是用来完成代理对象的自动创建功能的。</p>
<p>​
工作原理是，<code>&lt;aop:aspectj-autoproxy&gt;</code>通过扫描找到@Aspect定义的切面类，再由切面类根据切入点找到目标类的目标方法，再由通知类型找到切入的时间点。</p>
<p><strong>注意：如果找不到对应的目标方法，那么就不会把代理代码植入到目标类的目标方法中，执行的就是原来代码。</strong></p>
<h4
id="使用applicationcontext获取目标对象">使用ApplicationContext获取目标对象</h4>
<p>这里的目标对象就是经过aspectj修改后的代理对象，也就是目标类对象。</p>
<h3 id="一个例子">一个例子</h3>
<p>​ 使用注解完成容器管理对象。</p>
<p>先创建接口有一个doSome方法，实现这个接口创建一个目标类，实现doSome方法，然后再创建切面类，实现在执行doSome方法之前，输出当前时间的功能。</p>
<p>创建接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SomeService</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doSome</span><span class="params">(String name, Integer age)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;someService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SomeService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSome</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;名字为 :&quot;</span> +name + <span class="string">&quot;, 年龄为：&quot;</span> + age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建切面类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component(&quot;myAspect&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(public void doSome(String, Integer))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myBefore</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;切面功能，输出执行时间：&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">SomeService</span> <span class="variable">proxy</span> <span class="operator">=</span> (SomeService) applicationContext.getBean(<span class="string">&quot;someService&quot;</span>);</span><br><span class="line">    proxy.doSome(<span class="string">&quot;Jack&quot;</span>, <span class="number">21</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<p><img src="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/image/image-20201129145426769.png" alt="image-20201129145426769" style="zoom:50%;" /></p>
<h3 id="注意">注意</h3>
<p>如果目标类有接口，那么Spring框架默认会使用jdk的动态代理，如果没有接口，那么spring会使用CGLIB代理。</p>
<p>但是如果希望在有接口的情况下，让Spring使用CGLIB动态代理，就需要在自动代理生成器标签中添加一个属性，<code>proxy-target-class
= "true"</code></p>
<p>即<code>&lt;aop:aspectj-autoproxy  proxy-target-class="true"
/&gt;</code></p>
<p>就可以让Spring默认使用CGLIB代理。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/5-%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84DI%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/5-%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84DI%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">5-基于注解的DI实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:05 / 修改时间：16:59:26" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:05+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基于注解的di实现">5-基于注解的DI实现</h1>
<p>通过注解来配置信息是为了简化IOC容器的配置，注解可以把对象添加到IOC容器中、处理对象依赖关系。</p>
<h2 id="使用注解步骤">使用注解步骤</h2>
<ol type="1">
<li>加入maven的依赖spring-context，加入的同时，也加入了spring-aop的依赖，使用注解必须要使用spring-aop依赖</li>
<li>在类中加入spring的依赖</li>
<li>在spring配置文件中，加入一个组件扫描器的标签，来说明注解在项目中的位置</li>
</ol>
<h2 id="加入组件扫描器">加入组件扫描器</h2>
<p>在配置文件中加入组件扫描器的标签 <code>&lt;context:component-scan
base-package="" /&gt;</code></p>
<p>属性：base-package，指定注解要扫描的包名</p>
<p>扫描器的工作方式：spring会扫描遍历base-package指定的包，递归的找到所有类中的注解，按照注解的功能创建对象或者给属性赋值。</p>
<p>context是指对应的命名空间，<code>xmlns:context="http://www.springframework.org/schema/context"</code>。</p>
<h3 id="指定多个包的方式">指定多个包的方式</h3>
<p>有三种方式</p>
<ol type="1">
<li>使用多个<code>&lt;context:component-scan base-package=""
/&gt;</code>语句，指定不同的包</li>
<li>使用分隔符; 或 ,分割多个包名，例如<code>&lt;context:component-scan
base-package="org.example.package1;org.example.package2"</code></li>
<li>指定需要扫描的所有包的父包，例如package1和package2的父包是org.example，那么就直接指定这个包即可</li>
</ol>
<h2 id="主要学习的注解">主要学习的注解</h2>
<p>有以下几个：</p>
<ul>
<li><span class="citation" data-cites="Component">@Component</span></li>
<li><span class="citation" data-cites="Respotory">@Respotory</span></li>
<li><span class="citation" data-cites="Service">@Service</span></li>
<li><span class="citation"
data-cites="Controller">@Controller</span></li>
<li><span class="citation" data-cites="Value">@Value</span></li>
<li><span class="citation" data-cites="Autowired">@Autowired</span></li>
<li><span class="citation" data-cites="Resource">@Resource</span></li>
</ul>
<h3 id="component"><span class="citation"
data-cites="Component">@Component</span></h3>
<p>这个注解用来创建对象，等同于标签bean，</p>
<p>属性：value，表示这个对象的名称，是唯一的。也可以省略value，直接写对象名称，必须加引号</p>
<p>如果不写这个属性，那么spring会使用默认的对象名称：类名的首字母小写，例如类名为Student，那么默认名称为student</p>
<p>位置：在类的上面</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.point1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(value = &quot;myStudent&quot;)</span> <span class="comment">//指定对象的唯一名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3
id="与component用法类似的三个注解">与@Component用法类似的三个注解</h3>
<ol type="1">
<li><span class="citation"
data-cites="Repository">@Repository</span>(用在持久层类上面)：放在DAO的实现类上面，表示创建DAO对象，DAO对象可以访问数据库</li>
<li><span class="citation"
data-cites="Service">@Service</span>(用在业务层类上面)：放在service的实现类上面，创建service对象，该对象是做业务处理，有事务等功能</li>
<li><span class="citation"
data-cites="Controller">@Controller</span>(用在控制器上面)：放在控制器类上面，创建控制器对象，能够接受用户提交的参数，显示请求处理结果，如Servet</li>
</ol>
<p>这三个注解和@Comonent的用法大致相同。都可以创建对象，但是这三个注解还有额外的功能。</p>
<p><span class="citation"
data-cites="Repository">@Repository</span>，<span class="citation"
data-cites="Service">@Service</span>，<span class="citation"
data-cites="Controller是用来给项目对象分层的">@Controller是用来给项目对象分层的</span>，它们可以赋予对象不同的角色。是比@Component的功能丰富的。</p>
<p>当一个类不是以上三个类型，或者不知道是不是这三个类，就可以使用@Component</p>
<h3 id="value简单类型的赋值"><span class="citation"
data-cites="Value">@Value</span>(简单类型的赋值)</h3>
<p>用来给简单类型的属性赋值</p>
<p>属性：value，String类型，表示简单类型的属性值。可不写value，直接写属性值。必须加引号</p>
<p>位置：</p>
<ol type="1">
<li>在属性定义上面，不需要set方法，推荐使用这种</li>
<li>在set方法上面</li>
</ol>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;Jack&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;21&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然也可以使用在set方法上，用的很少，不再举例了。</p>
<h3 id="引用类型的赋值">引用类型的赋值</h3>
<p>两个注解@Autowired和<span class="citation"
data-cites="Resource都可以给引用类型赋值">@Resource都可以给引用类型赋值</span>。</p>
<h4 id="autowired"><span class="citation"
data-cites="Autowired">@Autowired</span></h4>
<p>实现引用类型的赋值，使用的是自动注入原理。支持byName、byType</p>
<p><span class="citation"
data-cites="Autowired默认使用的是byType自动注入">@Autowired默认使用的是byType自动注入</span>。</p>
<p>属性：required，布尔类型，默认为true</p>
<p>​ 当required=ture：表示如果引用类型赋值失败，程序报错，并终止执行</p>
<p>​
当required=false：表示如果引用类型赋值失败，程序正常运行，引用类型为null</p>
<p><strong>推荐使用true。</strong></p>
<p>位置：</p>
<ol type="1">
<li>在属性定义上面，无需set方法，推荐使用这个</li>
<li>在set方法上面，很少使用</li>
</ol>
<p>例子：</p>
<p>定义引用类型School：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;mySchool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">School</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;清华大学&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;北京海淀区&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;School&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, address=&#x27;&quot;</span> + address + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Student的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;Jack&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;21&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//使用Autowired来进行引用类型注入</span></span><br><span class="line">    <span class="keyword">private</span> School school;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, school=&quot;</span> + school +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用byname方式">使用byName方式</h5>
<p>如果要使用byName方式，那么还需要在属性上面加入@Qualifier(value="bean的id")：表示使用指定名称的bean完成赋值</p>
<p>位置</p>
<p>在上面代码@Autowired的上面或者下面加入<code>@Qualifier(value="mySchool")</code>，就可以实现byName方式赋值</p>
<h4 id="resource"><span class="citation"
data-cites="Resource">@Resource</span></h4>
<p>来自jdk的注解，spring框架提供了对这个注解的功能支持，可以使用它给引用类型赋值</p>
<p>使用的也是自动注入原理，支持byName、byType，默认使用byName</p>
<p>属性：name：当使用byName方法时，指定bean的id，<strong>name不能省略</strong>；使用byType方法，不需要这个属性</p>
<p>位置：</p>
<ol type="1">
<li>在属性定义上面，无需set方法，推荐</li>
<li>在set方法上面</li>
</ol>
<p><strong>注意：</strong></p>
<ul>
<li><p><strong>如果没有指定name属性，会使用byType；如果指定了name属性，那么使用byName，如果找不到，会报错</strong></p></li>
<li><p><strong>这个注解在javax包，也就是java的拓展包里，在java
11以后，jdk不再包括javax，所以需要在pom.xml中手动导入。</strong></p></li>
</ul>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;Jack&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;21&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> School school;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, school=&quot;</span> + school +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，<span class="citation"
data-cites="Resource没有使用name属性">@Resource没有使用name属性</span>，但是程序可以运行成功，就是因为byName失败后，自动使用byType赋值。</p>
<p>​</p>
<h2 id="配置文件和注解两种方式">配置文件和注解两种方式</h2>
<p>这两种方式都可以使用，但是更多的是使用注解。注解为主，配置文件为辅。</p>
<p>但是如果修改较多的话，那么就可以使用配置文件。</p>
<p>如果不需要怎么改变修改的，就可以使用注解。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhaoquaner.github.io/2022/05/11/Spring/4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://crayon-1302863897.cos.ap-beijing.myqcloud.com/blog_images/avatar.png">
      <meta itemprop="name" content="ZhaoXin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 赵圈儿的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/Spring/4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">4-配置文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-11 13:57:04 / 修改时间：16:59:24" itemprop="dateCreated datePublished" datetime="2022-05-11T13:57:04+08:00">2022-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="配置文件">4-配置文件</h1>
<p>在实际项目开发过程中，常使用多个配置文件。</p>
<p>多个配置文件的优势：</p>
<ul>
<li>每个文件的大小比单独一个文件要小很多，读取保存快，效率高</li>
<li>避免多人协作，竞争带来的冲突。</li>
</ul>
<p>配置文件分类有也很多种方式：</p>
<ul>
<li><p>按模块分类，一个模块一个配置文件</p></li>
<li><p>按业务分类，例如数据访问层一个配置文件，服务层一个配置文件</p>
<p>. . .</p></li>
</ul>
<h2 id="包含关系的多配置文件">包含关系的多配置文件</h2>
<p>当有多个配置文件时，可以使用一个总的配置文件来把这些配置文件都包含起来。</p>
<p>例如有student.xml和teacher.xml配置文件，那么可以有一个total.xml文件来把前两个配置文件包含在一起</p>
<p>语法为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;其他配置文件的路径&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>关键词："classpath:"
表示类路径，在spring的配置文件中要指定其他文件位置，需要使用classpath，告诉spring去哪里加载读取文件。</p>
<p>主配置文件中一般不包含bean，它只是用来包含其他配置文件的。</p>
<p>上面的例子可以这样写：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:student.xml&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">import</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:teacher.xml&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">import</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然实际上，其他配置文件会在其他目录里，这里只是演示。</p>
<p>在使用ClassPathApplicationContext读取这个总配置文件时，就会将包含的两个配置文件一块读取。</p>
<h3 id="使用通配符">使用通配符</h3>
<p>在包含关系的配置文件中，可以使用通配符(*：表示任意字符)</p>
<p>例如有两个配置文件：spring-student.xml、spring-teacher.xml</p>
<p>那么在总配置文件中引入是可以这样写： <code>&lt;import
resource="classpath:spring-*.xml"
/&gt;</code>，这样就可以将两个配置文件都导入</p>
<p><strong>注意：</strong></p>
<ul>
<li>总的配置文件名称不能包含在通配符的范围里面，否则会造成死循环。例如上面例子，总配置文件不能起名叫spring-*.xml</li>
<li>要使用通配符匹配的所有配置文件要在一个目录里，不同目录没法匹配</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZhaoXin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
